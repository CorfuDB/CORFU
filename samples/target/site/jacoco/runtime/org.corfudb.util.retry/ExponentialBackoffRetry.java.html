<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ExponentialBackoffRetry.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">samples</a> &gt; <a href="../index.html" class="el_bundle">runtime</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.util.retry</a> &gt; <span class="el_source">ExponentialBackoffRetry.java</span></div><h1>ExponentialBackoffRetry.java</h1><pre class="source lang-java linenums">package org.corfudb.util.retry;

import java.time.Duration;
import java.util.Random;
import java.util.concurrent.TimeUnit;

import lombok.Getter;
import lombok.Setter;
import lombok.extern.slf4j.Slf4j;
import org.corfudb.util.Sleep;


/**
 * This class implements a basic exponential backoff retry.
 *
 * &lt;p&gt;Created by mwei on 9/1/15.
 */
<span class="fc" id="L18">@Slf4j</span>
public class ExponentialBackoffRetry&lt;E extends Exception, F extends Exception,
        G extends Exception, H extends Exception, O, A extends IRetry&gt;
        extends AbstractRetry&lt;E, F, G, H, O, ExponentialBackoffRetry&gt; {

    private static final int DEFAULT_BASE = 2;
    private static final float DEFAULT_RANDOM_PORTION = 0f;
<span class="fc" id="L25">    private static final Duration DEFAULT_BACKOFF_DURATION = Duration.ofMinutes(1);</span>
<span class="fc" id="L26">    private long retryCounter = 0;</span>
<span class="fc" id="L27">    private long nextBackoffTime = 0;</span>

<span class="pc" id="L29">    @Getter</span>
<span class="fc" id="L30">    @Setter</span>
    private Duration backoffDuration = DEFAULT_BACKOFF_DURATION;

    /**
     * Base to multiply.
     */
<span class="pc" id="L36">    @Getter @Setter</span>
    private int base = DEFAULT_BASE;

    /**
     * Portion of the number to be randomized, between 0 and 1.
     * 0 - no random portion, 1 - randomize everything.
     */
<span class="pc" id="L43">    @Getter @Setter</span>
    private float randomPortion = DEFAULT_RANDOM_PORTION;

    /**
     * Additional fixed retry time in milliseconds for each retry.
     */
<span class="pc" id="L49">    @Getter</span>
<span class="fc" id="L50">    @Setter</span>
    private long extraWait = 0;

    /**
     * Maximum duration at which the wait time needs to be capped.
     */
<span class="pc" id="L56">    @Getter</span>
<span class="fc" id="L57">    @Setter</span>
    private Duration maxRetryThreshold = Duration.ZERO;

    public ExponentialBackoffRetry(IRetryable runFunction) {
<span class="fc" id="L61">        super(runFunction);</span>
<span class="fc" id="L62">    }</span>

    @Override
    public void nextWait() {
<span class="fc bfc" id="L66" title="All 2 branches covered.">        if (nextBackoffTime == 0) {</span>
<span class="fc" id="L67">            nextBackoffTime = System.currentTimeMillis() + backoffDuration.toMillis();</span>
        }
<span class="fc" id="L69">        retryCounter++;</span>
<span class="fc" id="L70">        long sleepTime = (long) Math.pow(base, retryCounter);</span>
<span class="fc" id="L71">        sleepTime += extraWait;</span>
<span class="fc" id="L72">        float randomPart = new Random().nextFloat() * randomPortion;</span>
<span class="fc" id="L73">        sleepTime -= sleepTime * randomPart;</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (maxRetryThreshold.toMillis() &gt; 0) {</span>
<span class="fc" id="L75">            sleepTime = Math.min(sleepTime, maxRetryThreshold.toMillis());</span>
        }

<span class="pc bpc" id="L78" title="1 of 2 branches missed.">        if (System.currentTimeMillis() + sleepTime &gt; nextBackoffTime) {</span>
<span class="nc" id="L79">            nextBackoffTime = 0;</span>
<span class="nc" id="L80">            retryCounter = 1;</span>
<span class="nc" id="L81">            sleepTime = base + extraWait;</span>
<span class="nc" id="L82">            sleepTime -= sleepTime * randomPart;</span>
        }
<span class="fc" id="L84">        Sleep.sleepUninterruptibly(Duration.ofMillis(sleepTime));</span>
<span class="fc" id="L85">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>