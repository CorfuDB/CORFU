<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>LayoutBuilder.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">samples</a> &gt; <a href="../index.html" class="el_bundle">runtime</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.runtime.view</a> &gt; <span class="el_source">LayoutBuilder.java</span></div><h1>LayoutBuilder.java</h1><pre class="source lang-java linenums">package org.corfudb.runtime.view;

import com.google.common.collect.Sets;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import lombok.NonNull;
import lombok.extern.slf4j.Slf4j;

import org.corfudb.runtime.exceptions.LayoutModificationException;
import org.corfudb.runtime.view.Layout.LayoutSegment;
import org.corfudb.runtime.view.Layout.LayoutStripe;

/**
 * A builder that allows us to make modifications to a layout and construct
 * the modified layout.
 *
 * &lt;p&gt;Created by zlokhandwala on 10/12/16.
 */
<span class="fc" id="L23">@Slf4j</span>
public class LayoutBuilder {

    /**
     * Updated layout.
     */
    private Layout layout;
    /**
     * Stores the epoch of the layout.
     */
    private long epoch;

    /**
     * Copies the attributes of the layout to make modifications.
     *
     * @param layout a non null base layout to be modified.
     */
<span class="fc bfc" id="L40" title="All 2 branches covered.">    public LayoutBuilder(@NonNull Layout layout) {</span>
<span class="fc" id="L41">        this.layout = new Layout(layout);</span>
<span class="fc" id="L42">        this.epoch = layout.getEpoch();</span>
<span class="fc" id="L43">    }</span>

    /**
     * Set layout's epoch
     * @param epoch epoch to set
     * @return this builder
     */
    public LayoutBuilder setEpoch(long epoch) {
<span class="fc" id="L51">        this.epoch = epoch;</span>
<span class="fc" id="L52">        return this;</span>
    }

    /**
     * Clears the existing unresponsive servers.
     *
     * @return this builder
     */
    public LayoutBuilder clearUnResponsiveServers() {
<span class="nc" id="L61">        layout.getUnresponsiveServers().clear();</span>
<span class="nc" id="L62">        return this;</span>
    }

    /**
     * Adds unresponsive servers in the list.
     *
     * @param endpoints a non null set of Strings representing endpoints to
     *                  be added to the list of layout's unresponsive servers.
     *
     * @return this builder
     */
<span class="fc bfc" id="L73" title="All 2 branches covered.">    public LayoutBuilder addUnresponsiveServers(@NonNull Set&lt;String&gt; endpoints) {</span>
<span class="fc" id="L74">        List&lt;String&gt; unresponsiveServers = layout.getUnresponsiveServers();</span>
<span class="fc" id="L75">        unresponsiveServers.addAll(endpoints);</span>
<span class="fc" id="L76">        return this;</span>
    }

    /**
     * Removes unresponsive servers.
     *
     * @param endpoints a non null set of endpoints to be removed from the layout's
     *                  list of unresponsive servers.
     *
     * @return this builder
     */
<span class="fc bfc" id="L87" title="All 2 branches covered.">    public LayoutBuilder removeUnresponsiveServers(@NonNull Set&lt;String&gt; endpoints) {</span>
<span class="fc" id="L88">        layout.getUnresponsiveServers().removeAll(endpoints);</span>
<span class="fc" id="L89">        return this;</span>
    }

    /**
     * Removes a server from layout's list of unresponsive servers.
     *
     * @param endpoint the endpoint of the unresponsive server to be removed
     *
     * @return this builder
     */
<span class="fc bfc" id="L99" title="All 2 branches covered.">    public LayoutBuilder removeUnresponsiveServer(@NonNull String endpoint) {</span>
<span class="fc" id="L100">        layout.getUnresponsiveServers().remove(endpoint);</span>
<span class="fc" id="L101">        return this;</span>
    }

    /**
     * Removes the Layout Server passed. If the layout does not include the endpoint
     * no action will take place.
     *
     * @param endpoint a non null string representing the Layout Server endpoint
     *                 that needs to be removed
     * @return this builder
     *
     * @throws LayoutModificationException is thrown if the provided endpoint is the last remaining
     *         Layout Server
     */
<span class="fc bfc" id="L115" title="All 2 branches covered.">    public LayoutBuilder removeLayoutServer(@NonNull String endpoint) {</span>

        // Only remove the endpoint if it does not attempt to remove the last remaining layout server
<span class="fc bfc" id="L118" title="All 2 branches covered.">        if (layout.getLayoutServers().size() == 1 &amp;&amp;</span>
<span class="fc bfc" id="L119" title="All 2 branches covered.">            layout.getLayoutServers().get(0).equals(endpoint)) {</span>
<span class="fc" id="L120">            log.warn(&quot;Skipped removing layout server as {} is the last remaining layout servers.&quot;,</span>
                    endpoint);
<span class="fc" id="L122">            throw new LayoutModificationException(</span>
                    &quot;Attempting to remove all layout servers.&quot;);
        } else {
<span class="fc" id="L125">            layout.getLayoutServers().remove(endpoint);</span>
        }

<span class="fc" id="L128">        return this;</span>
    }

    /**
     * Removes all the Layout Server endpoints present in the set passed. This method
     * first checks that removing the provided endpoints does not remove all the Layout
     * Servers in the layout. In case that at least one layout server remains after the
     * removal. It proceeds with removing Layout Server endpoints provided while
     * silently dismissing any of provided endpoints which are not included as one of the
     * Layout Servers in the layout.
     *
     * @param endpoints a non null set of Strings representing Layout server endpoints
     *                  to be removed from the layout.
     *
     * @return this builder
     *
     * @throws LayoutModificationException is thrown if removing the provided set of
     *         endpoints result in removing all the remaining Layout Servers in
     *         the layout.
     */
<span class="fc bfc" id="L148" title="All 2 branches covered.">    public LayoutBuilder removeLayoutServers(@NonNull Set&lt;String&gt; endpoints) {</span>

        // Only remove the endpoints if it does not attempt to remove all layout's layout servers
<span class="fc bfc" id="L151" title="All 2 branches covered.">        if(endpoints.containsAll(layout.getLayoutServers())) {</span>
<span class="fc" id="L152">            log.warn(&quot;Skipped removing layout servers as remove request of {} would remove all &quot; +</span>
                     &quot;layout servers {}.&quot;,
<span class="fc" id="L154">                     endpoints.toString(),</span>
<span class="fc" id="L155">                     layout.getLayoutServers());</span>
<span class="fc" id="L156">            throw new LayoutModificationException(&quot;Attempting to remove all layout servers.&quot;);</span>
        } else {
<span class="fc" id="L158">            layout.getLayoutServers().removeAll(endpoints);</span>
        }

<span class="fc" id="L161">        return this;</span>
    }

    /**
     * Adds a new layout server.
     *
     * @param endpoint a non null String representing the Layout Server endpoint
     *                 to be added.
     *
     * @return this builder
     */
<span class="fc bfc" id="L172" title="All 2 branches covered.">    public LayoutBuilder addLayoutServer(@NonNull String endpoint) {</span>
<span class="fc" id="L173">        layout.getLayoutServers().add(endpoint);</span>
<span class="fc" id="L174">        return this;</span>
    }

    /**
     * Adds a new sequencer server.
     *
     * @param endpoint a non null String representing the Sequencer Server endpoint
     *                 to be added.
     *
     * @return this builder
     */
<span class="fc bfc" id="L185" title="All 2 branches covered.">    public LayoutBuilder addSequencerServer(@NonNull String endpoint) {</span>
<span class="fc" id="L186">        layout.getSequencers().add(endpoint);</span>
<span class="fc" id="L187">        return this;</span>
    }

    /**
     * Adds a new logunit server.
     * For every segment the start address is inclusive and the end is exclusive.
     * The latest open segment (which has its end address as infinity) is now closed at address
     * 'globalLogTail' (exclusive).
     * A new segment is opened for all future writes. The segment starts at 'globalLogTail' and
     * ends at infinity. This new segment contains the new logunit server to be added in the
     * specified stripe.
     *
     * @param stripeIndex        stripe index where new endpoint should be added.
     * @param globalLogTail      Global log tail to split segment.
     * @param newLogunitEndpoint a non null String representing Logunit endpoint to be added.
     * @return this builder
     */
    public LayoutBuilder addLogunitServer(int stripeIndex, long globalLogTail,
<span class="fc bfc" id="L205" title="All 2 branches covered.">                                          @NonNull String newLogunitEndpoint) {</span>
<span class="fc" id="L206">        List&lt;LayoutSegment&gt; layoutSegmentList = layout.getSegments();</span>
<span class="fc" id="L207">        LayoutSegment segmentToSplit = layoutSegmentList.remove(layoutSegmentList.size() - 1);</span>

        // Close the existing segment with the provided globalLogTail.
<span class="fc" id="L210">        LayoutSegment closedSegment = new LayoutSegment(segmentToSplit.getReplicationMode(),</span>
<span class="fc" id="L211">                segmentToSplit.getStart(),</span>
                globalLogTail + 1,
<span class="fc" id="L213">                segmentToSplit.getStripes());</span>

<span class="fc" id="L215">        List&lt;String&gt; logunitServerList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L216">        logunitServerList.addAll(segmentToSplit.getStripes()</span>
<span class="fc" id="L217">                .get(stripeIndex)</span>
<span class="fc" id="L218">                .getLogServers());</span>
<span class="fc" id="L219">        logunitServerList.add(newLogunitEndpoint);</span>

        // Create new stripe list with the new logunit server added.
<span class="fc" id="L222">        LayoutStripe newStripe = new LayoutStripe(logunitServerList);</span>
<span class="fc" id="L223">        List&lt;LayoutStripe&gt; newStripeList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L224">        newStripeList.addAll(segmentToSplit.getStripes());</span>
<span class="fc" id="L225">        newStripeList.remove(stripeIndex);</span>
<span class="fc" id="L226">        newStripeList.add(stripeIndex, newStripe);</span>

<span class="fc" id="L228">        LayoutSegment openSegment = new LayoutSegment(segmentToSplit.getReplicationMode(),</span>
                globalLogTail + 1,
<span class="fc" id="L230">                segmentToSplit.getEnd(),</span>
                newStripeList);
<span class="fc" id="L232">        layoutSegmentList.add(layoutSegmentList.size(), closedSegment);</span>
<span class="fc" id="L233">        layoutSegmentList.add(layoutSegmentList.size(), openSegment);</span>
<span class="fc" id="L234">        return this;</span>
    }

    /**
     * Add a log unit server to a specific stripe in a specific segment.
     *
     * @param endpoint     a non null endpoint to add to the log unit list.
     * @param segmentIndex Segment to which the log unit is to be added.
     * @param stripeIndex  Stripe to which the log unit is to be added.
     *
     * @return this builder
     */
<span class="fc bfc" id="L246" title="All 2 branches covered.">    public LayoutBuilder addLogunitServerToSegment(@NonNull String endpoint,</span>
                                                   int segmentIndex,
                                                   int stripeIndex) {
<span class="fc" id="L249">        LayoutStripe stripe = layout.getSegments().get(segmentIndex).getStripes().get(stripeIndex);</span>
<span class="fc bfc" id="L250" title="All 2 branches covered.">        if (!stripe.getLogServers().contains(endpoint)) {</span>
<span class="fc" id="L251">            stripe.getLogServers().add(endpoint);</span>
        }
<span class="fc" id="L253">        return this;</span>
    }

    /**
     * Merges the specified segment and the segment before this.
     * No addition or removal of stripes are allowed.
     * Only 1 log unit server addition/removal allowed between segments.
     *
     * @param segmentIndex Segment to merge.
     *
     * @return this builder
     */
    public LayoutBuilder mergePreviousSegment(int segmentIndex) {
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">        if (segmentIndex &lt; 1) {</span>
<span class="nc" id="L267">            log.warn(&quot;mergePreviousSegment: No segments to merge.&quot;);</span>
<span class="nc" id="L268">            return this;</span>
        }

<span class="fc" id="L271">        List&lt;LayoutSegment&gt; layoutSegmentList = layout.getSegments();</span>
<span class="fc" id="L272">        if (layoutSegmentList.get(segmentIndex).start</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">                != layoutSegmentList.get(segmentIndex - 1).end) {</span>
<span class="nc" id="L274">            throw new LayoutModificationException(&quot;Cannot merge disjoint segments.&quot;);</span>
        }

<span class="fc" id="L277">        List&lt;LayoutStripe&gt; oldSegmentStripeList = layoutSegmentList.get(segmentIndex - 1).getStripes();</span>
<span class="fc" id="L278">        List&lt;LayoutStripe&gt; newSegmentStripeList = layoutSegmentList.get(segmentIndex).getStripes();</span>

<span class="fc" id="L280">        int allowedUpdates = 1;</span>
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">        if (oldSegmentStripeList.size() != newSegmentStripeList.size()) {</span>
<span class="nc" id="L282">            throw new LayoutModificationException(&quot;Stripe addition/deletion not allowed.&quot;);</span>
        }
<span class="fc bfc" id="L284" title="All 2 branches covered.">        for (int i = 0; i &lt; oldSegmentStripeList.size(); i++) {</span>
<span class="fc" id="L285">            Set&lt;String&gt; oldSegmentStripe =</span>
<span class="fc" id="L286">                    new HashSet&lt;&gt;(oldSegmentStripeList.get(i).getLogServers());</span>
<span class="fc" id="L287">            Set&lt;String&gt; newSegmentStripe =</span>
<span class="fc" id="L288">                    new HashSet&lt;&gt;(newSegmentStripeList.get(i).getLogServers());</span>
<span class="fc" id="L289">            Set&lt;String&gt; differences = Sets.difference(</span>
<span class="fc" id="L290">                    Sets.union(oldSegmentStripe, newSegmentStripe),</span>
<span class="fc" id="L291">                    Sets.intersection(oldSegmentStripe, newSegmentStripe));</span>
<span class="fc" id="L292">            allowedUpdates = allowedUpdates - differences.size();</span>
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">            if (allowedUpdates &lt; 0) {</span>
<span class="nc" id="L294">                throw new LayoutModificationException(</span>
                        &quot;At most &quot; + allowedUpdates + &quot; log unit server update allowed.&quot;);
            }
        }

<span class="fc" id="L299">        LayoutSegment mergedSegment = new LayoutSegment(layoutSegmentList.get(segmentIndex)</span>
<span class="fc" id="L300">                .getReplicationMode(),</span>
<span class="fc" id="L301">                layoutSegmentList.get(segmentIndex - 1).getStart(),</span>
<span class="fc" id="L302">                layoutSegmentList.get(segmentIndex).getEnd(),</span>
<span class="fc" id="L303">                layoutSegmentList.get(segmentIndex).getStripes());</span>
<span class="fc" id="L304">        layoutSegmentList.remove(segmentIndex);</span>
<span class="fc" id="L305">        layoutSegmentList.remove(segmentIndex - 1);</span>
<span class="fc" id="L306">        layoutSegmentList.add(segmentIndex - 1, mergedSegment);</span>
<span class="fc" id="L307">        return this;</span>
    }

    /**
     * Moves a responsive server to the top of the sequencer server list.
     * If all have failed, throws exception.
     *
     * @param endpoints a non null set of Strings representing failed endpoints
     *
     * @return this builder
     *
     * @throws LayoutModificationException is thrown if none of the sequencers in layout
     *         can be moved to the top of sequencer server list due to being unresponsive
     *         or a failed endpoint.
     */
<span class="fc bfc" id="L322" title="All 2 branches covered.">    public LayoutBuilder assignResponsiveSequencerAsPrimary(@NonNull Set&lt;String&gt; endpoints) {</span>

<span class="fc" id="L324">        List&lt;String&gt; modifiedSequencerServers = new ArrayList&lt;&gt;(layout.getSequencers());</span>
<span class="fc bfc" id="L325" title="All 2 branches covered.">        for (int i = 0; i &lt; modifiedSequencerServers.size(); i++) {</span>
<span class="fc" id="L326">            String sequencerServer = modifiedSequencerServers.get(i);</span>

            // Add a sequencer server given sequencerServer is not already included in
            // endpoints AND it is not included in the unresponsive nodes of the layout.
<span class="fc bfc" id="L330" title="All 2 branches covered.">            if (!endpoints.contains(sequencerServer) &amp;&amp;</span>
<span class="fc bfc" id="L331" title="All 2 branches covered.">                !layout.getUnresponsiveServers().contains(sequencerServer)) {</span>
<span class="fc" id="L332">                modifiedSequencerServers.remove(sequencerServer);</span>
<span class="fc" id="L333">                modifiedSequencerServers.add(0, sequencerServer);</span>
<span class="fc" id="L334">                layout.setSequencers(modifiedSequencerServers);</span>
<span class="fc" id="L335">                return this;</span>
            }
        }

<span class="fc" id="L339">        log.warn(&quot;Failover to a responsive sequencer server failed. Each of the layout &quot; +</span>
                 &quot;sequencers:{} is either a failed endpoint or an unresponsive server&quot;,
<span class="fc" id="L341">                 modifiedSequencerServers.toString());</span>
<span class="fc" id="L342">        throw new LayoutModificationException(&quot;All sequencers failed.&quot;);</span>
    }

    /**
     * Removes the Sequencer Server passed. If the layout does not include the endpoint
     * no action will take place.
     *
     * @param endpoint a non null string representing the sequencer server endpoint
     *                 which needs to be removed
     * @return this builder
     *
     * @throws LayoutModificationException is thrown if the provided endpoint is the last remaining
     *         Sequencer Server
     */
<span class="fc bfc" id="L356" title="All 2 branches covered.">    public LayoutBuilder removeSequencerServer(@NonNull String endpoint) {</span>

        // Only remove the endpoint if it does not attempt to remove the last remaining sequencer
<span class="fc bfc" id="L359" title="All 2 branches covered.">        if (layout.getSequencers().size() == 1 &amp;&amp;</span>
<span class="fc bfc" id="L360" title="All 2 branches covered.">            layout.getSequencers().get(0).equals(endpoint)) {</span>
<span class="fc" id="L361">            log.warn(&quot;Skipped removing sequencer as {} is the last remaining sequencer.&quot;,</span>
                    endpoint);
<span class="fc" id="L363">            throw new LayoutModificationException(</span>
                    &quot;Attempting to remove all sequencers.&quot;);
        } else {
<span class="fc" id="L366">            layout.getSequencers().remove(endpoint);</span>
        }

<span class="fc" id="L369">        return this;</span>
    }

    /**
     * Removes all the Sequencer Server endpoints present in the set passed. This method
     * first checks that removing the provided endpoints does not remove all the Sequencer
     * Servers in the layout. In case that at least one sequencer server remains after the
     * removal. It proceeds with removing Sequencer Server endpoints provided while
     * silently dismissing any of provided endpoints which are not included as one of the
     * Sequencer Servers in the layout.
     *
     * @param endpoints a non null set of Strings representing sequencer server endpoints
     *                  to be removed from the layout.
     *
     * @return this builder
     *
     * @throws LayoutModificationException is thrown if removing the provided set of
     *         endpoints result in removing all the remaining Sequencer Servers in
     *         the layout.
     */
<span class="fc bfc" id="L389" title="All 2 branches covered.">    public LayoutBuilder removeSequencerServers(@NonNull Set&lt;String&gt; endpoints) {</span>

        // Only remove the endpoints if it does not attempt to remove all layout's sequencers
<span class="fc bfc" id="L392" title="All 2 branches covered.">        if (endpoints.containsAll(layout.getSequencers())) {</span>
<span class="fc" id="L393">            log.warn(&quot;Skipped removing sequencers as remove request of {} would remove all &quot; +</span>
                     &quot;sequencers {}.&quot;,
<span class="fc" id="L395">                     endpoints.toString(),</span>
<span class="fc" id="L396">                     layout.getSequencers());</span>
<span class="fc" id="L397">            throw new LayoutModificationException(&quot;Attempting to remove all sequencers.&quot;);</span>
        } else {
<span class="fc" id="L399">            layout.getSequencers().removeAll(endpoints);</span>
        }

<span class="fc" id="L402">        return this;</span>
    }

    /**
     * Remove an endpoint from a segment.
     *
     * @param endpoint             A non null String representing the endpoint to
     *                             be removed
     * @param layoutStripe         A non null stripe to remove the endpoint from
     * @param minReplicationFactor The least number of nodes needed to
     *                             maintain redundancy
     */
<span class="fc bfc" id="L414" title="All 2 branches covered.">    public void removeFromStripe(@NonNull String endpoint,</span>
<span class="pc bpc" id="L415" title="1 of 2 branches missed.">                                 @NonNull LayoutStripe layoutStripe,</span>
                                 int minReplicationFactor) {
<span class="fc bfc" id="L417" title="All 2 branches covered.">        if (layoutStripe.getLogServers().remove(endpoint)) {</span>
<span class="pc bpc" id="L418" title="1 of 2 branches missed.">            if (layoutStripe.getLogServers().isEmpty()) {</span>
<span class="nc" id="L419">                throw new LayoutModificationException(</span>
                        &quot;Attempting to remove all logunit in stripe. &quot;
                                + &quot;No replicas available.&quot;);
            }

<span class="fc bfc" id="L424" title="All 2 branches covered.">            if (layoutStripe.getLogServers().size() &lt; minReplicationFactor) {</span>
<span class="fc" id="L425">                throw new LayoutModificationException(</span>
                        &quot;Change will cause redundancy loss!&quot;);
            }
        }
<span class="fc" id="L429">    }</span>

    /**
     * Removes the Log unit endpoint from the layout.
     *
     * @param endpoint a non null Log unit server to be removed
     *
     * @return this builder
     */
<span class="fc bfc" id="L438" title="All 2 branches covered.">    public LayoutBuilder removeLogunitServer(@NonNull String endpoint) {</span>

<span class="fc" id="L440">        Layout tempLayout = new Layout(layout);</span>

<span class="fc" id="L442">        List&lt;LayoutSegment&gt; layoutSegments = tempLayout.getSegments();</span>
<span class="fc bfc" id="L443" title="All 2 branches covered.">        for (LayoutSegment layoutSegment : layoutSegments) {</span>
<span class="fc bfc" id="L444" title="All 2 branches covered.">            for (LayoutStripe layoutStripe : layoutSegment.getStripes()) {</span>
<span class="fc" id="L445">                int minReplicationFactor = layoutSegment.getReplicationMode()</span>
<span class="fc" id="L446">                        .getMinReplicationFactor(tempLayout, layoutStripe);</span>
<span class="fc" id="L447">                removeFromStripe(endpoint, layoutStripe, minReplicationFactor);</span>
<span class="fc" id="L448">            }</span>
<span class="fc" id="L449">        }</span>
<span class="fc" id="L450">        layout = tempLayout;</span>
<span class="fc" id="L451">        return this;</span>
    }

    /**
     * Removes the Log unit endpoints from the layout.
     *
     * @param endpoints a non null set of Strings representing Log unit servers
     *                  to be removed
     *
     * @return this builder
     */
<span class="fc bfc" id="L462" title="All 2 branches covered.">    public LayoutBuilder removeLogunitServers(@NonNull Set&lt;String&gt; endpoints) {</span>

<span class="fc" id="L464">        Layout tempLayout = new Layout(layout);</span>

<span class="fc" id="L466">        List&lt;LayoutSegment&gt; layoutSegments = tempLayout.getSegments();</span>
<span class="fc bfc" id="L467" title="All 2 branches covered.">        for (LayoutSegment layoutSegment : layoutSegments) {</span>
<span class="fc bfc" id="L468" title="All 2 branches covered.">            for (LayoutStripe layoutStripe : layoutSegment.getStripes()) {</span>
<span class="fc bfc" id="L469" title="All 2 branches covered.">                for (String endpoint : endpoints) {</span>
<span class="fc" id="L470">                    int minReplicationFactor = layoutSegment.getReplicationMode()</span>
<span class="fc" id="L471">                            .getMinReplicationFactor(tempLayout, layoutStripe);</span>
<span class="fc" id="L472">                    removeFromStripe(endpoint, layoutStripe, minReplicationFactor);</span>
<span class="fc" id="L473">                }</span>
<span class="fc" id="L474">            }</span>
<span class="fc" id="L475">        }</span>
<span class="fc" id="L476">        layout = tempLayout;</span>
<span class="fc" id="L477">        return this;</span>
    }

    /**
     * Builds and returns the layout with the modified attributes.
     *
     * @return new layout
     */
    public Layout build() {
<span class="fc" id="L486">        return new Layout(</span>
<span class="fc" id="L487">                layout.getLayoutServers(),</span>
<span class="fc" id="L488">                layout.getSequencers(),</span>
<span class="fc" id="L489">                layout.getSegments(),</span>
<span class="fc" id="L490">                layout.getUnresponsiveServers(),</span>
                this.epoch,
<span class="fc" id="L492">                layout.getClusterId());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>