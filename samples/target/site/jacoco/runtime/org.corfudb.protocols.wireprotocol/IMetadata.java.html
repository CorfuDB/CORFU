<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>IMetadata.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">samples</a> &gt; <a href="../index.html" class="el_bundle">runtime</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.protocols.wireprotocol</a> &gt; <span class="el_source">IMetadata.java</span></div><h1>IMetadata.java</h1><pre class="source lang-java linenums">package org.corfudb.protocols.wireprotocol;

import com.esotericsoftware.kryo.NotNull;
import com.google.common.reflect.TypeToken;

import java.util.Arrays;
import java.util.Collections;
import java.util.EnumMap;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.UUID;
import java.util.function.Function;
import java.util.stream.Collectors;

import javax.annotation.Nullable;

import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.RequiredArgsConstructor;
import lombok.Value;

import org.corfudb.protocols.logprotocol.CheckpointEntry;
import org.corfudb.runtime.view.Address;
import org.corfudb.runtime.view.Layout;

import static org.corfudb.protocols.wireprotocol.IMetadata.LogUnitMetadataType.CHECKPOINTED_STREAM_ID;
import static org.corfudb.protocols.wireprotocol.IMetadata.LogUnitMetadataType.CHECKPOINTED_STREAM_START_LOG_ADDRESS;
import static org.corfudb.protocols.wireprotocol.IMetadata.LogUnitMetadataType.CHECKPOINT_ID;
import static org.corfudb.protocols.wireprotocol.IMetadata.LogUnitMetadataType.CHECKPOINT_TYPE;

/**
 * Created by mwei on 9/18/15.
 */
public interface IMetadata {

<span class="fc" id="L37">    Map&lt;Byte, LogUnitMetadataType&gt; metadataTypeMap =</span>
<span class="fc" id="L38">            Arrays.&lt;LogUnitMetadataType&gt;stream(LogUnitMetadataType.values())</span>
<span class="fc" id="L39">                    .collect(Collectors.toMap(LogUnitMetadataType::asByte, Function.identity()));</span>

    EnumMap&lt;IMetadata.LogUnitMetadataType, Object&gt; getMetadataMap();

    /**
     * Get the streams that belong to this append.
     *
     * @return A set of streams that belong to this append.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    default Set&lt;UUID&gt; getStreams() {
<span class="fc" id="L50">        return ((Map&lt;UUID, Long&gt;) getMetadataMap().getOrDefault(</span>
<span class="fc" id="L51">                LogUnitMetadataType.BACKPOINTER_MAP, Collections.emptyMap())).keySet();</span>
    }

    /**
     * Get whether or not this entry contains a given stream.
     * @param stream    The stream to check.
     * @return          True, if the entry contains the given stream.
     */
    default boolean containsStream(UUID stream) {
<span class="fc" id="L60">        return  getBackpointerMap().keySet().contains(stream);</span>
    }

    /**
     * Get the rank of this append.
     *
     * @return The rank of this append.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    @Nullable
    default DataRank getRank() {
<span class="fc" id="L71">        return (DataRank) getMetadataMap().getOrDefault(LogUnitMetadataType.RANK,</span>
                null);
    }

    /**
     * Set the rank of this append.
     *
     * @param rank The rank of this append.
     */
    default void setRank(@Nullable DataRank rank) {
<span class="fc" id="L81">        EnumMap&lt;LogUnitMetadataType, Object&gt; map = getMetadataMap();</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">        if (rank != null) {</span>
<span class="fc" id="L83">            map.put(LogUnitMetadataType.RANK, rank);</span>
        } else {
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">            if (map.containsKey(LogUnitMetadataType.RANK)) {</span>
<span class="nc" id="L86">                map.remove(LogUnitMetadataType.RANK);</span>
            }
        }
<span class="fc" id="L89">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    default Map&lt;UUID, Long&gt; getBackpointerMap() {
<span class="fc" id="L93">        return (Map&lt;UUID, Long&gt;) getMetadataMap().getOrDefault(LogUnitMetadataType.BACKPOINTER_MAP,</span>
                Collections.EMPTY_MAP);
    }

    default void setBackpointerMap(Map&lt;UUID, Long&gt; backpointerMap) {
<span class="fc" id="L98">        getMetadataMap().put(LogUnitMetadataType.BACKPOINTER_MAP, backpointerMap);</span>
<span class="fc" id="L99">    }</span>

    default void setGlobalAddress(Long address) {
<span class="fc" id="L102">        getMetadataMap().put(LogUnitMetadataType.GLOBAL_ADDRESS, address);</span>
<span class="fc" id="L103">    }</span>

    default void setEpoch(Long epoch) {
<span class="fc" id="L106">        getMetadataMap().put(LogUnitMetadataType.EPOCH, epoch);</span>
<span class="fc" id="L107">    }</span>

<span class="fc" id="L109">    default void setClientId(UUID clientId) {getMetadataMap().put(LogUnitMetadataType.CLIENT_ID, clientId); }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    @Nullable
    default UUID getClientId() {
<span class="fc" id="L114">            return (UUID) getMetadataMap().getOrDefault(LogUnitMetadataType.CLIENT_ID,</span>
                    null);
    }

<span class="fc" id="L118">    default void setThreadId(Long threadId) {getMetadataMap().put(LogUnitMetadataType.THREAD_ID, threadId); }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    @Nullable
    default Long getThreadId() {
<span class="fc" id="L123">        return (Long) getMetadataMap().getOrDefault(LogUnitMetadataType.THREAD_ID,</span>
                null);
    }


    /**
     * Get Log's global address (global tail).
     * @return global address
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    default Long getGlobalAddress() {
<span class="fc" id="L134">        return Optional.ofNullable((Long) getMetadataMap()</span>
<span class="fc" id="L135">                .get(LogUnitMetadataType.GLOBAL_ADDRESS)).orElse(Address.NON_ADDRESS);</span>
    }

    /**
     * Get Log's epoch.
     *
     * @return epoch.
     */
    default Long getEpoch() {
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">        if (getMetadataMap() == null</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">                || getMetadataMap().get(LogUnitMetadataType.EPOCH) == null) {</span>
<span class="fc" id="L146">            return Layout.INVALID_EPOCH;</span>
        }
<span class="fc" id="L148">        return Optional.ofNullable((Long) getMetadataMap()</span>
<span class="fc" id="L149">                .get(LogUnitMetadataType.EPOCH)).orElse(Layout.INVALID_EPOCH);</span>
    }

    // TODO(Maithem): replace getGlobalAddress and getEpoch with getToken
    default Token getToken() {
<span class="fc" id="L154">        return new Token(getEpoch(), getGlobalAddress());</span>
    }

    default boolean hasCheckpointMetadata() {
<span class="pc bpc" id="L158" title="1 of 4 branches missed.">        return getCheckpointType() != null &amp;&amp; getCheckpointId() != null;</span>
    }

    /**
     * Get checkpoint type.
     */
    @Nullable
    default CheckpointEntry.CheckpointEntryType getCheckpointType() {
<span class="fc" id="L166">        return (CheckpointEntry.CheckpointEntryType) getMetadataMap()</span>
<span class="fc" id="L167">                .getOrDefault(LogUnitMetadataType.CHECKPOINT_TYPE,</span>
                        null);
    }

    default void setCheckpointType(CheckpointEntry.CheckpointEntryType type) {
<span class="fc" id="L172">        getMetadataMap().put(CHECKPOINT_TYPE, type);</span>
<span class="fc" id="L173">    }</span>

    @Nullable
    @SuppressWarnings({&quot;checkstyle:abbreviationaswordinname&quot;, &quot;checkstyle:membername&quot;})
    default UUID getCheckpointId() {
<span class="fc" id="L178">        return (UUID) getMetadataMap().getOrDefault(LogUnitMetadataType.CHECKPOINT_ID,</span>
                null);
    }

    @SuppressWarnings({&quot;checkstyle:abbreviationaswordinname&quot;, &quot;checkstyle:membername&quot;})
    default void setCheckpointId(UUID id) {
<span class="fc" id="L184">        getMetadataMap().put(CHECKPOINT_ID, id);</span>
<span class="fc" id="L185">    }</span>

    default UUID getCheckpointedStreamId() {
<span class="fc" id="L188">        return (UUID) getMetadataMap().getOrDefault(LogUnitMetadataType.CHECKPOINTED_STREAM_ID,</span>
                null);
    }

    default void setCheckpointedStreamId(UUID Id) {
<span class="fc" id="L193">        getMetadataMap().put(CHECKPOINTED_STREAM_ID, Id);</span>
<span class="fc" id="L194">    }</span>

    /**
     * Returns the tail of the checkpointed stream at the time of taking the checkpoint snapshot.
     */
    default Long getCheckpointedStreamStartLogAddress() {
<span class="fc" id="L200">        return (Long) getMetadataMap()</span>
<span class="fc" id="L201">                .getOrDefault(LogUnitMetadataType.CHECKPOINTED_STREAM_START_LOG_ADDRESS,</span>
<span class="fc" id="L202">                        Address.NO_BACKPOINTER);</span>
    }

    default void setCheckpointedStreamStartLogAddress(Long startLogAddress) {
<span class="fc" id="L206">        getMetadataMap().put(CHECKPOINTED_STREAM_START_LOG_ADDRESS, startLogAddress);</span>
<span class="fc" id="L207">    }</span>

<span class="pc" id="L209">    @RequiredArgsConstructor</span>
    enum LogUnitMetadataType implements ITypedEnum {
<span class="fc" id="L211">        RANK(1, TypeToken.of(DataRank.class)),</span>
<span class="fc" id="L212">        BACKPOINTER_MAP(3, new TypeToken&lt;Map&lt;UUID, Long&gt;&gt;() {}),</span>
<span class="fc" id="L213">        GLOBAL_ADDRESS(4, TypeToken.of(Long.class)),</span>
<span class="fc" id="L214">        CHECKPOINT_TYPE(6, TypeToken.of(CheckpointEntry.CheckpointEntryType.class)),</span>
<span class="fc" id="L215">        CHECKPOINT_ID(7, TypeToken.of(UUID.class)),</span>
<span class="fc" id="L216">        CHECKPOINTED_STREAM_ID(8, TypeToken.of(UUID.class)),</span>
<span class="fc" id="L217">        CHECKPOINTED_STREAM_START_LOG_ADDRESS(9, TypeToken.of(Long.class)),</span>
<span class="fc" id="L218">        CLIENT_ID(10, TypeToken.of(UUID.class)),</span>
<span class="fc" id="L219">        THREAD_ID(11, TypeToken.of(Long.class)),</span>
<span class="fc" id="L220">        EPOCH(12, TypeToken.of(Long.class))</span>
        ;
        final int type;
<span class="fc" id="L223">        @Getter</span>
        final TypeToken&lt;?&gt; componentType;

        public byte asByte() {
<span class="fc" id="L227">            return (byte) type;</span>
        }

<span class="fc" id="L230">        public static Map&lt;Byte, LogUnitMetadataType&gt; typeMap =</span>
<span class="fc" id="L231">                Arrays.&lt;LogUnitMetadataType&gt;stream(LogUnitMetadataType.values())</span>
<span class="fc" id="L232">                        .collect(Collectors.toMap(LogUnitMetadataType::asByte,</span>
<span class="fc" id="L233">                                Function.identity()));</span>
    }

<span class="nc bnc" id="L236" title="All 14 branches missed.">    @Value</span>
<span class="fc" id="L237">    @AllArgsConstructor</span>
    class DataRank implements Comparable&lt;DataRank&gt; {
<span class="fc" id="L239">        public long rank;</span>
        @NotNull
<span class="fc" id="L241">        public UUID uuid;</span>

        public DataRank(long rank) {
<span class="fc" id="L244">            this(rank, UUID.randomUUID());</span>
<span class="fc" id="L245">        }</span>

        public DataRank buildHigherRank() {
<span class="fc" id="L248">            return new DataRank(rank + 1, uuid);</span>
        }

        @Override
        public int compareTo(DataRank o) {
<span class="fc" id="L253">            int rankCompared = Long.compare(this.rank, o.rank);</span>
<span class="fc bfc" id="L254" title="All 2 branches covered.">            if (rankCompared == 0) {</span>
<span class="fc" id="L255">                return uuid.compareTo(o.getUuid());</span>
            } else {
<span class="fc" id="L257">                return rankCompared;</span>
            }
        }
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>