<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AbstractStreamContext.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">samples</a> &gt; <a href="../index.html" class="el_bundle">runtime</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.runtime.view.stream</a> &gt; <span class="el_source">AbstractStreamContext.java</span></div><h1>AbstractStreamContext.java</h1><pre class="source lang-java linenums">package org.corfudb.runtime.view.stream;

import java.util.UUID;

import lombok.Data;
import lombok.Getter;
import lombok.Setter;
import org.corfudb.runtime.exceptions.TrimmedException;
import org.corfudb.runtime.view.Address;


/** A data class which keeps data for each stream context.
 * Stream contexts represent a copy-on-write context - for each source
 * stream a single context is used up until maxGlobalAddress, at which the new
 * *destination* stream is used by popping the context off the stream
 * context stack.
 * Created by mwei on 1/6/17.
 */
public abstract class AbstractStreamContext implements
        Comparable&lt;AbstractStreamContext&gt; {

    /**
     * The ID (stream ID) of this context.
     */
    final UUID id;

    /**
     * The maximum global address that we should follow to, or
     * Address.MAX, if this is the final context.
     */
    final long maxGlobalAddress;

    /**
     * The trim mark for Garbage Collection.
     *
     * This is based on the log trim mark,
     * and is used to discard data in the stream views before the trim mark.
     *
     * Note: Data cannot be discarded deliberately as there might be active transactions
     * still operating in this space, we need to ensure the object is synced beyond this threshold
     * before discarding data, or data might be temporarily loss or resets will slow performance.
     *
     */
<span class="pc" id="L44">    @Getter</span>
<span class="nc" id="L45">    @Setter</span>
    protected long gcTrimMark = 0;

    /**
     * A pointer to the current global address, which is the
     * global address of the most recently added entry.
     */
<span class="fc" id="L52">    @Getter</span>
    protected long globalPointer;

    /**
     * Set Global Pointer and validate its position does not fall in the GC trim range.
     *
     * If it falls we should throw a Trim Exception as this data no longer
     * exists in the log and will be GC from all layers.
     *
     * @param globalPointer position to set the global pointer to.
     */
    protected void setGlobalPointerCheckGCTrimMark(long globalPointer) {
<span class="fc" id="L64">        validateGlobalPointerPosition(globalPointer);</span>
<span class="fc" id="L65">        this.setGlobalPointer(globalPointer);</span>
<span class="fc" id="L66">    }</span>

    protected void setGlobalPointer(long globalPointer) {
<span class="fc" id="L69">        this.globalPointer = globalPointer;</span>
<span class="fc" id="L70">    }</span>

    /**
     * Validate that Global Pointer position does not fall in the GC trim range.
     *
     * Note: we need to throw an exception whenever this is the case, as keeping active transactions
     * in this range can lead to 'temporal' data loss when GC cycles ate started, i.e., sync to an old version
     * and trimming the resolved queue, before the updates between old version and trim mark are applied to the object.
     *
     * @param globalPointer position to set the global pointer to.
     */
    protected void validateGlobalPointerPosition(long globalPointer) {
<span class="pc bpc" id="L82" title="1 of 4 branches missed.">        if (globalPointer &lt; gcTrimMark &amp;&amp; globalPointer &gt; Address.NON_ADDRESS) {</span>
<span class="nc" id="L83">            throw new TrimmedException(String.format(&quot;Global pointer position[%s] is in GC trim range. GC Trim mark: [%s]. This address is trimmed from the log.&quot;,</span>
<span class="nc" id="L84">                    globalPointer, gcTrimMark));</span>
        }
<span class="fc" id="L86">    }</span>

    /**
     * Generate a new stream context given the id of the stream and the
     * maximum address to read to.
     * @param id                  The id of the stream.
     * @param maxGlobalAddress    The maximum address to read up to.
     */
    public AbstractStreamContext(final UUID id,
<span class="fc" id="L95">                                 final long maxGlobalAddress) {</span>
<span class="fc" id="L96">        this.id = id;</span>
<span class="fc" id="L97">        this.maxGlobalAddress = maxGlobalAddress;</span>
<span class="fc" id="L98">        this.setGlobalPointerCheckGCTrimMark(Address.NON_ADDRESS);</span>
<span class="fc" id="L99">    }</span>

    /** Reset the stream context. */
    void reset() {
<span class="fc" id="L103">        globalPointer = Address.NON_ADDRESS;</span>
<span class="fc" id="L104">    }</span>

    /** Move the pointer for the context to the given global address,
     * updating any structures if necessary.
     * @param globalAddress     The address to seek to.
     */
    void seek(long globalAddress) {
        // by default we just need to update the pointer.
        // we subtract by one, since the NEXT read will
        // have to include globalAddress.
        // FIXME change this; what if globalAddress==0? somewhere down the line,
        // some code will compare this with NEVER_READ
<span class="fc" id="L116">        globalPointer = globalAddress - 1;</span>
<span class="fc" id="L117">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public int compareTo(AbstractStreamContext o) {
<span class="fc" id="L124">        return Long.compare(this.maxGlobalAddress, o.maxGlobalAddress);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>