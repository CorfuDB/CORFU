<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Transaction.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">samples</a> &gt; <a href="../index.html" class="el_bundle">runtime</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.runtime.object.transactions</a> &gt; <span class="el_source">Transaction.java</span></div><h1>Transaction.java</h1><pre class="source lang-java linenums">package org.corfudb.runtime.object.transactions;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Builder.Default;
import lombok.Getter;
import lombok.NonNull;

import org.corfudb.protocols.wireprotocol.Token;
import org.corfudb.runtime.CorfuRuntime;


/**
 * Represents a transaction.
 *
 * &lt;p&gt;Created by Maithem on 12/5/18.
 */

@Getter
<span class="nc bnc" id="L20" title="All 2 branches missed.">@AllArgsConstructor</span>
<span class="nc bnc" id="L21" title="All 4 branches missed.">@Builder</span>
public class Transaction {

    /**
     * The runtime for the context.
     */
    @NonNull
<span class="nc" id="L28">    final CorfuRuntime runtime;</span>

    /**
     * The type of context to build.
     */
    @Default
<span class="nc" id="L34">    final TransactionType type = TransactionType.OPTIMISTIC;;</span>

    /**
     * For snapshot transactions, the address the
     * snapshot will start at.
     */
    @Default
<span class="nc" id="L41">    final Token snapshot = Token.UNINITIALIZED;;</span>

    /**
     * Start the transaction with the parameters given
     * to the builder.
     */
    public void begin() {
<span class="nc" id="L48">        verify();</span>
<span class="nc" id="L49">        TransactionalContext.newContext(type.get.apply(this));</span>
<span class="nc" id="L50">    }</span>

    public boolean isLoggingEnabled() {
<span class="nc" id="L53">        return runtime.getObjectsView().isTransactionLogging();</span>
    }

    /**
     * Verifies that this transaction has a valid snapshot and context.
     */
    private void verify() {
<span class="nc" id="L60">        final AbstractTransactionalContext parentCtx = TransactionalContext.getCurrentContext();</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">        if (parentCtx != null) {</span>
            // In a nested transaction, the runtime should be the same as the parent's
<span class="nc bnc" id="L63" title="All 2 branches missed.">            if (parentCtx.getTransaction().getRuntime() != this.runtime) {</span>
<span class="nc" id="L64">                throw new IllegalStateException(</span>
                        &quot;Attempting to nest transactions from different clients!&quot;);
            }

            // In a nested transaction, the transaction type should be the same as the parent's
<span class="nc bnc" id="L69" title="All 2 branches missed.">            if (type != parentCtx.getTransaction().getType()) {</span>
<span class="nc" id="L70">                String msg = String.format(&quot;Attempting to nest transactions with a &quot; +</span>
                                &quot;different transaction type, parent type=%s, nested type=%s&quot;,
<span class="nc" id="L72">                        parentCtx.getTransaction().getType(), this.getType());</span>
<span class="nc" id="L73">                throw new IllegalArgumentException(msg);</span>
            }

            // In a nested transaction, the first read timestamp needs to come from the root.
<span class="nc" id="L77">            Token parentTimestamp = parentCtx.getSnapshotTimestamp();</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">            if (!this.snapshot.equals(Token.UNINITIALIZED)</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">                    &amp;&amp; !this.snapshot.equals(parentTimestamp)) {</span>
<span class="nc" id="L80">                String msg = String.format(&quot;Attempting to nest transactions with&quot; +</span>
                                &quot; different timestamps, parent ts=%s, user defined ts=%s&quot;,
<span class="nc" id="L82">                        parentCtx.getSnapshotTimestamp(), this.snapshot);</span>
<span class="nc" id="L83">                throw new IllegalArgumentException(msg);</span>
            }
        }
        // User-Defined Snapshot Verification
        //        else if (!this.snapshot.equals(Token.UNINITIALIZED)) {
        //            // Since this is a user-defined snapshot we must make sure that
        //            // the corresponding log position is valid (i.e. the slot has been written)
        //            ILogData pos = getRuntime().getAddressSpaceView().peek(this.snapshot.getSequence());
        //            if (pos == null || !pos.getToken().equals(this.snapshot)) {
        //                String msg = String.format(&quot;User Defined snapshot(ts=%s) is invalid&quot;, this.snapshot);
        //                throw new IllegalArgumentException(msg);
        //            }
        //        }
<span class="nc" id="L96">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>