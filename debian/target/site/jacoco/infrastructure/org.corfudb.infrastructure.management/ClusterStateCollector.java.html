<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ClusterStateCollector.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">debian</a> &gt; <a href="../index.html" class="el_bundle">infrastructure</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.infrastructure.management</a> &gt; <span class="el_source">ClusterStateCollector.java</span></div><h1>ClusterStateCollector.java</h1><pre class="source lang-java linenums">package org.corfudb.infrastructure.management;

import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableMap;
import lombok.Builder;
import lombok.NonNull;
import lombok.extern.slf4j.Slf4j;
import org.corfudb.infrastructure.management.ClusterStateContext.HeartbeatCounter;
import org.corfudb.protocols.wireprotocol.ClusterState;
import org.corfudb.protocols.wireprotocol.NodeState;
import org.corfudb.protocols.wireprotocol.SequencerMetrics;
import org.corfudb.protocols.wireprotocol.failuredetector.NodeConnectivity;
import org.corfudb.protocols.wireprotocol.failuredetector.NodeConnectivity.ConnectionStatus;
import org.corfudb.runtime.exceptions.WrongEpochException;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.CompletableFuture;

/**
 * Collects information about cluster state.
 * Provides list of servers in the cluster with higher epochs.
 * Builds the {@link ClusterState} and local {@link NodeState}.
 *
 * The collector navigates via list of requests represented as CompletableFuture-s
 * and collecting information about cluster.
 */
<span class="pc bpc" id="L30" title="3 of 6 branches missed.">@Builder</span>
<span class="fc" id="L31">@Slf4j</span>
public class ClusterStateCollector {
    @NonNull
    private final String localEndpoint;
    @NonNull
    private final Map&lt;String, CompletableFuture&lt;NodeState&gt;&gt; clusterState;

    @NonNull
    private final HeartbeatCounter heartbeatCounter;

    /**
     * Provides cluster state
     * @param epoch current epoch
     * @param sequencerMetrics sequencer metrics
     * @return cluster state
     */
    public ClusterState collectClusterState(
            long epoch, ImmutableList&lt;String&gt; unresponsiveNodes,
            SequencerMetrics sequencerMetrics) {

<span class="fc" id="L51">        Map&lt;String, NodeState&gt; nodeStates = new HashMap&lt;&gt;();</span>

<span class="fc" id="L53">        nodeStates.put(localEndpoint, collectLocalNodeState(epoch, sequencerMetrics));</span>
<span class="fc" id="L54">        nodeStates.putAll(collectRemoteStates());</span>

<span class="fc" id="L56">        return ClusterState.builder()</span>
<span class="fc" id="L57">                .localEndpoint(localEndpoint)</span>
<span class="fc" id="L58">                .nodes(ImmutableMap.copyOf(nodeStates))</span>
<span class="fc" id="L59">                .unresponsiveNodes(unresponsiveNodes)</span>
<span class="fc" id="L60">                .build();</span>
    }

    /**
     * Provides list of servers containing different epochs to this server.
     *
     * @return map of endpoint:epoch entries
     */
    public ImmutableMap&lt;String, Long&gt; collectWrongEpochs() {
<span class="fc" id="L69">        Map&lt;String, Long&gt; wrongEpochs = new HashMap&lt;&gt;();</span>

<span class="fc" id="L71">        clusterState.forEach((server, state) -&gt; {</span>
            try {
                //Add a node to connectedNodes list if node responded with its NodeState
<span class="fc" id="L74">                state.get();</span>
<span class="fc" id="L75">            } catch (Exception e) {</span>
                //Collect wrong epoch, don't add the node to a failedNodes list
<span class="fc bfc" id="L77" title="All 2 branches covered.">                if (e.getCause() instanceof WrongEpochException) {</span>
<span class="fc" id="L78">                    wrongEpochs.put(server, ((WrongEpochException) e.getCause()).getCorrectEpoch());</span>
                }
<span class="fc" id="L80">            }</span>
<span class="fc" id="L81">        });</span>

<span class="fc" id="L83">        return  ImmutableMap.copyOf(wrongEpochs);</span>
    }

    private Map&lt;String, NodeState&gt; collectRemoteStates() {
<span class="fc" id="L87">        Map&lt;String, NodeState&gt; nodeStates = new HashMap&lt;&gt;();</span>
        //Collect information about cluster (exclude local node):
<span class="fc" id="L89">        clusterState.forEach((server, state) -&gt; {</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">            if (server.equals(localEndpoint)) {</span>
<span class="fc" id="L91">                return;</span>
            }

            try {
                //Add a node to connectedNodes list if node responded with its NodeState
<span class="fc" id="L96">                NodeState nodeState = state.get();</span>

                //Ignore local node response. Local NodeState will be built lately
<span class="fc" id="L99">                nodeStates.put(server, nodeState);</span>
<span class="fc" id="L100">            } catch (Exception e) {</span>
                //Add unavailable NodeState in the list if an exception happened. Ignore for localhost
<span class="fc" id="L102">                nodeStates.put(server, NodeState.getUnavailableNodeState(server));</span>
<span class="fc" id="L103">            }</span>
<span class="fc" id="L104">        });</span>

<span class="fc" id="L106">        return nodeStates;</span>
    }

    private NodeState collectLocalNodeState(long epoch, SequencerMetrics sequencerMetrics) {
<span class="fc" id="L110">        log.trace(&quot;Get local node state&quot;);</span>

<span class="fc" id="L112">        Map&lt;String, ConnectionStatus&gt; localNodeConnections = new HashMap&lt;&gt;();</span>
<span class="fc" id="L113">        clusterState.forEach((server, state) -&gt; {</span>
            try {
                //Add a node to connectedNodes list if node responded with its NodeState
<span class="fc" id="L116">                state.get();</span>
<span class="fc" id="L117">                localNodeConnections.put(server, ConnectionStatus.OK);</span>
<span class="fc" id="L118">            } catch (Exception e) {</span>
                ConnectionStatus nodeStatus;
<span class="fc bfc" id="L120" title="All 2 branches covered.">                if (e.getCause() instanceof WrongEpochException) {</span>
<span class="fc" id="L121">                    nodeStatus = ConnectionStatus.OK;</span>
                } else {
<span class="fc" id="L123">                    nodeStatus = ConnectionStatus.FAILED;</span>
                }

<span class="fc" id="L126">                localNodeConnections.put(server, nodeStatus);</span>
<span class="fc" id="L127">            }</span>
<span class="fc" id="L128">        });</span>

        //Build local NodeState based on pings.
<span class="fc" id="L131">        NodeConnectivity localConnectivity = NodeConnectivity.connectivity(</span>
<span class="fc" id="L132">                localEndpoint, ImmutableMap.copyOf(localNodeConnections)</span>
        );

<span class="fc" id="L135">        return NodeState.builder()</span>
<span class="fc" id="L136">                .connectivity(localConnectivity)</span>
<span class="fc" id="L137">                .heartbeat(new NodeState.HeartbeatTimestamp(epoch, heartbeatCounter.incrementHeartbeat()))</span>
<span class="fc" id="L138">                .sequencerMetrics(sequencerMetrics)</span>
<span class="fc" id="L139">                .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>