<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CorfuMsgHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">debian</a> &gt; <a href="../index.html" class="el_bundle">infrastructure</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.infrastructure</a> &gt; <span class="el_source">CorfuMsgHandler.java</span></div><h1>CorfuMsgHandler.java</h1><pre class="source lang-java linenums">package org.corfudb.infrastructure;

import com.codahale.metrics.Timer;
import io.netty.channel.ChannelHandlerContext;
import lombok.extern.slf4j.Slf4j;
import org.corfudb.protocols.wireprotocol.CorfuMsg;
import org.corfudb.protocols.wireprotocol.CorfuMsgType;
import org.corfudb.protocols.wireprotocol.ExceptionMsg;
import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;
import org.corfudb.util.CorfuComponent;
import org.corfudb.util.MetricsUtils;

import javax.annotation.Nonnull;
import java.lang.invoke.LambdaMetafactory;
import java.lang.invoke.MethodHandle;
import java.lang.invoke.MethodHandles;
import java.lang.invoke.MethodType;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;
import java.util.Arrays;
import java.util.EnumMap;
import java.util.HashMap;
import java.util.Map;
import java.util.Set;

/**
 * This class implements message handlers for {@link AbstractServer} implementations.
 * Servers define methods with signatures which follow the signature of the {@link Handler}
 * functional interface, and generate a handler using the
 * {@link this#generateHandler(MethodHandles.Lookup, AbstractServer)} method.
 *
 * &lt;p&gt;For maximum performance, make the handlers static whenever possible.
 * Handlers should be as short as possible (not block), since handler threads come from a
 * shared pool used by all servers. Blocking operations should be offloaded to I/O threads.
 *
 * &lt;p&gt;Created by mwei on 7/26/16.
 */
<span class="nc" id="L38">@Slf4j</span>
public class CorfuMsgHandler {

<span class="nc" id="L41">    private final Map&lt;CorfuMsgType, String&gt; timerNameCache = new HashMap&lt;&gt;();</span>

    /**
     * A functional interface for server message handlers. Server message handlers should
     * be fast and not block. If a handler blocks for an extended period of time, it will
     * exhaust the server's thread pool. I/O and other long operations should be handled
     * on another thread.
     */
    @FunctionalInterface
    interface Handler&lt;T extends CorfuMsg&gt; {
        void handle(@Nonnull T corfuMsg,
                    @Nonnull ChannelHandlerContext ctx,
                    @Nonnull IServerRouter r);
    }

    /** The handler map. */
    private final Map&lt;CorfuMsgType, Handler&gt; handlerMap;

    /** Get the types this handler will handle.
     *
     * @return  A set containing the types this handler will handle.
     */
    public Set&lt;CorfuMsgType&gt; getHandledTypes() {
<span class="nc" id="L64">        return handlerMap.keySet();</span>
    }

    /** Get a handler for a specific message type.
     *
     * @param type  The type to retrieve a handler for.
     * @return      A handler for the requested message type.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public Handler&lt;CorfuMsg&gt; getHandler(CorfuMsgType type) {
<span class="nc" id="L74">        return handlerMap.get(type);</span>
    }

    /** Construct a new instance of CorfuMsgHandler. */
<span class="nc" id="L78">    public CorfuMsgHandler() {</span>
<span class="nc" id="L79">        handlerMap = new EnumMap&lt;&gt;(CorfuMsgType.class);</span>
<span class="nc" id="L80">    }</span>

    /** Add a handler to this message handler.
     *
     * @param messageType       The type of CorfuMsg this handler will handle.
     * @param handler           The handler itself.
     * @param &lt;T&gt;               A CorfuMsg type.
     * @return                  This handler, to support chaining.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public &lt;T extends CorfuMsg&gt; CorfuMsgHandler addHandler(CorfuMsgType messageType,
                                                           Handler&lt;T&gt; handler) {
<span class="nc" id="L92">        handlerMap.put(messageType, handler);</span>
<span class="nc" id="L93">        return this;</span>
    }

    /** Handle an incoming CorfuMsg.
     *
     * @param message   The message to handle.
     * @param ctx       The channel handler context.
     * @param r         The server router.
     * @return          True, if the message was handled.
     *                  False otherwise.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public boolean handle(CorfuMsg message, ChannelHandlerContext ctx, IServerRouter r) {
        // Get the handler for the message type
<span class="nc" id="L107">        final Handler&lt;CorfuMsg&gt; handler = handlerMap.get(message.getMsgType());</span>
        // If present...
<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (handler != null) {</span>
            try {
<span class="nc" id="L111">                handler.handle(message, ctx, r);</span>
<span class="nc" id="L112">            } catch (Exception ex) {</span>
                // Log the exception during handling
<span class="nc" id="L114">                log.error(&quot;handle: Unhandled exception processing {} message&quot;,</span>
<span class="nc" id="L115">                        message.getMsgType(), ex);</span>
<span class="nc" id="L116">                r.sendResponse(ctx, message,</span>
<span class="nc" id="L117">                        CorfuMsgType.ERROR_SERVER_EXCEPTION.payloadMsg(new ExceptionMsg(ex)));</span>
<span class="nc" id="L118">            }</span>
            // Otherwise log the unexpected message.
        } else {
<span class="nc" id="L121">            log.error(&quot;handle: Unregistered message type {}&quot;, message.getMsgType());</span>
        }

<span class="nc bnc" id="L124" title="All 2 branches missed.">        return handler != null;</span>
    }

    /** Generate handlers for a particular server.
     *
     * @param caller    The context that is being used. Call MethodHandles.lookup() to obtain.
     * @param server    The object that implements the server.
     * @return          New message handler for caller class
     */
    public static CorfuMsgHandler generateHandler(@Nonnull final MethodHandles.Lookup caller,
            @Nonnull final AbstractServer server) {
<span class="nc" id="L135">        CorfuMsgHandler handler = new CorfuMsgHandler();</span>
<span class="nc" id="L136">        Arrays.stream(server.getClass().getDeclaredMethods())</span>
<span class="nc" id="L137">            .filter(method -&gt; method.isAnnotationPresent(ServerHandler.class))</span>
<span class="nc" id="L138">            .forEach(method -&gt; handler.registerMethod(caller, server, method));</span>
<span class="nc" id="L139">        return handler;</span>
    }



    /** Takes a method annotated with the {@link org.corfudb.infrastructure.ServerHandler}
     *  annotation, converts it into a lambda, and registers it in the {@code handlerMap}.
     * @param caller   The context that is being used. Call MethodHandles.lookup() to obtain.
     * @param server   The object that implements the server.
     * @param method   The method to be registered. Must be annotated with the
     *                 {@link ServerHandler} annotation.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void registerMethod(@Nonnull final MethodHandles.Lookup caller,
            @Nonnull final AbstractServer server,
            @Nonnull final Method method) {
<span class="nc" id="L155">        final ServerHandler annotation = method.getAnnotation(ServerHandler.class);</span>

<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (!method.getParameterTypes()[0].isAssignableFrom(annotation.type().messageType</span>
<span class="nc" id="L158">                .getRawType())) {</span>
<span class="nc" id="L159">            throw new UnrecoverableCorfuError(&quot;Incorrect message type, expected &quot;</span>
<span class="nc" id="L160">                + annotation.type().messageType.getRawType() + &quot; but provided &quot;</span>
<span class="nc" id="L161">                + method.getParameterTypes()[0]);</span>
        }
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (handlerMap.containsKey(annotation.type())) {</span>
<span class="nc" id="L164">            throw new UnrecoverableCorfuError(&quot;Handler for &quot; + annotation.type()</span>
                + &quot; already registered!&quot;);
        }
        // convert the method into a Java8 Lambda for maximum execution speed...
        try {
            Handler&lt;CorfuMsg&gt; h;
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (Modifier.isStatic(method.getModifiers())) {</span>
<span class="nc" id="L171">                MethodHandle mh = caller.unreflect(method);</span>
<span class="nc" id="L172">                MethodType mt = mh.type().changeParameterType(0, CorfuMsg.class);</span>
<span class="nc" id="L173">                h = (Handler&lt;CorfuMsg&gt;) LambdaMetafactory.metafactory(caller,</span>
<span class="nc" id="L174">                    &quot;handle&quot;, MethodType.methodType(Handler.class),</span>
<span class="nc" id="L175">                    mt, mh, mh.type())</span>
<span class="nc" id="L176">                    .getTarget().invokeExact();</span>

<span class="nc" id="L178">            } else {</span>
                // instance method, so we need to capture the type.
<span class="nc" id="L180">                MethodType mt = MethodType.methodType(method.getReturnType(),</span>
<span class="nc" id="L181">                        method.getParameterTypes());</span>
<span class="nc" id="L182">                MethodHandle mh = caller.findVirtual(server.getClass(), method.getName(), mt);</span>
<span class="nc" id="L183">                MethodType mtGeneric = mh.type().changeParameterType(1, CorfuMsg.class);</span>
<span class="nc" id="L184">                h = (Handler&lt;CorfuMsg&gt;) LambdaMetafactory.metafactory(caller,</span>
                    &quot;handle&quot;,
<span class="nc" id="L186">                    MethodType.methodType(Handler.class, server.getClass()),</span>
<span class="nc" id="L187">                    mtGeneric.dropParameterTypes(0, 1), mh,</span>
<span class="nc" id="L188">                    mh.type().dropParameterTypes(0, 1)).getTarget()</span>
<span class="nc" id="L189">                    .bindTo(server).invoke();</span>
            }
            // Install pre-conditions on handler
<span class="nc" id="L192">            final Handler&lt;CorfuMsg&gt; handler =</span>
<span class="nc" id="L193">                    generateConditionalHandler(server, annotation.type(), h);</span>
            // Install the handler in the map
<span class="nc" id="L195">            handlerMap.put(annotation.type(), handler);</span>
<span class="nc" id="L196">        } catch (Throwable e) {</span>
<span class="nc" id="L197">            log.error(&quot;Exception during message handler registration&quot;, e);</span>
<span class="nc" id="L198">            throw new UnrecoverableCorfuError(e);</span>

<span class="nc" id="L200">        }</span>
<span class="nc" id="L201">    }</span>

    /** Generate a conditional handler, which instruments the handler with metrics if configured
     * as enabled and checks whether the server is shutdown and ready.
     * @param server        The {@link AbstractServer} the message is being handled for.
     * @param type          The {@link CorfuMsgType} the message is being handled for.
     * @param handler       The {@link Handler} which handles the message.
     * @return              A new {@link Handler} which conditionally executes the handler
     *                      based on preconditions (whether the server is shutdown/ready).
     */
    private Handler&lt;CorfuMsg&gt; generateConditionalHandler(@Nonnull final AbstractServer server,
            @Nonnull final CorfuMsgType type,
            @Nonnull final Handler&lt;CorfuMsg&gt; handler) {
        // Generate a timer based on the Corfu message type
<span class="nc" id="L215">        final Timer timer = getTimer(type);</span>

        // Register the handler. Depending on metrics collection configuration by MetricsUtil,
        // handler will be instrumented by the metrics context.
<span class="nc" id="L219">        return (msg, ctx, r) -&gt; {</span>
<span class="nc" id="L220">            try (Timer.Context context = MetricsUtils.getConditionalContext(timer)) {</span>
<span class="nc" id="L221">                handler.handle(msg, ctx, r);</span>
<span class="nc bnc" id="L222" title="All 8 branches missed.">            }</span>
<span class="nc" id="L223">        };</span>
    }

    // Create a timer using cached timer name for the corresponding type
    private Timer getTimer(@Nonnull CorfuMsgType type) {
<span class="nc" id="L228">        timerNameCache.computeIfAbsent(type,</span>
<span class="nc" id="L229">                                       aType -&gt; (CorfuComponent.INFRA_MSG_HANDLER +</span>
<span class="nc" id="L230">                                                 aType.name().toLowerCase()));</span>

<span class="nc" id="L232">        return ServerContext.getMetrics().timer(timerNameCache.get(type));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>