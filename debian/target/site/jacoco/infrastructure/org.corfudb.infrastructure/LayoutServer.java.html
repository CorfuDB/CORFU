<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>LayoutServer.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">debian</a> &gt; <a href="../index.html" class="el_bundle">infrastructure</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.infrastructure</a> &gt; <span class="el_source">LayoutServer.java</span></div><h1>LayoutServer.java</h1><pre class="source lang-java linenums">package org.corfudb.infrastructure;

import com.google.common.annotations.VisibleForTesting;
import io.netty.channel.ChannelHandlerContext;
import lombok.Getter;
import lombok.NonNull;
import lombok.extern.slf4j.Slf4j;
import org.corfudb.infrastructure.ServerThreadFactory.ExceptionHandler;
import org.corfudb.infrastructure.paxos.PaxosDataStore;
import org.corfudb.protocols.wireprotocol.CorfuMsg;
import org.corfudb.protocols.wireprotocol.CorfuMsgType;
import org.corfudb.protocols.wireprotocol.CorfuPayloadMsg;
import org.corfudb.protocols.wireprotocol.LayoutBootstrapRequest;
import org.corfudb.protocols.wireprotocol.LayoutCommittedRequest;
import org.corfudb.protocols.wireprotocol.LayoutMsg;
import org.corfudb.protocols.wireprotocol.LayoutPrepareRequest;
import org.corfudb.protocols.wireprotocol.LayoutPrepareResponse;
import org.corfudb.protocols.wireprotocol.LayoutProposeRequest;
import org.corfudb.protocols.wireprotocol.LayoutProposeResponse;
import org.corfudb.runtime.view.Layout;

import javax.annotation.Nonnull;
import java.lang.invoke.MethodHandles;
import java.util.Collections;
import java.util.List;
import java.util.Optional;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

/**
 * The layout server serves layouts, which are used by clients to find the
 * Corfu infrastructure.
 *
 * &lt;p&gt;For replication and high availability, the layout server implements a
 * basic Paxos protocol. The layout server functions as a Paxos acceptor,
 * and accepts proposals from clients consisting of a rank and desired
 * layout. The protocol consists of three rounds:
 *
 * &lt;p&gt;1)   Prepare(rank) - Clients first contact each server with a rank.
 * If the server responds with ACK, the server promises not to
 * accept any requests with a rank lower than the given rank.
 * If the server responds with LAYOUT_PREPARE_REJECT, the server
 * informs the client of the current high rank and the request is
 * rejected.
 *
 * &lt;p&gt;2)   Propose(rank,layout) - Clients then contact each server with
 * the previously prepared rank and the desired layout. If no other
 * client has sent a prepare with a higher rank, the layout is
 * persisted, and the server begins serving that layout to other
 * clients. If the server responds with LAYOUT_PROPOSE_REJECT,
 * either another client has sent a prepare with a higher rank,
 * or this was a propose of a previously accepted rank.
 *
 * &lt;p&gt;3)   Committed(rank, layout) - Clients then send a hint to each layout
 * server that a new rank has been accepted by a quorum of
 * servers.
 *
 * &lt;p&gt;Created by mwei on 12/8/15.
 */
//TODO Finer grained synchronization needed for this class.
//TODO Need a janitor to cleanup old phases data and to fill up holes in layout history.
<span class="fc" id="L62">@Slf4j</span>
public class LayoutServer extends AbstractServer {

<span class="fc" id="L65">    @Getter</span>
    private final ServerContext serverContext;

    /**
     * Handler for this server.
     */
<span class="fc" id="L71">    @Getter</span>
    private final CorfuMsgHandler handler =
<span class="fc" id="L73">            CorfuMsgHandler.generateHandler(MethodHandles.lookup(), this);</span>

    @NonNull
    private final ExecutorService executor;

    @NonNull
    private final PaxosDataStore paxosDataStore;

    @Override
    public boolean isServerReadyToHandleMsg(CorfuMsg msg) {
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">        return getState() == ServerState.READY;</span>
    }

    @Override
    public ExecutorService getExecutor(CorfuMsgType corfuMsgType) {
<span class="fc" id="L88">        return executor;</span>
    }

    @Override
    public List&lt;ExecutorService&gt; getExecutors() {
<span class="fc" id="L93">        return Collections.singletonList(executor);</span>
    }

    /**
     * Returns new LayoutServer for context.
     *
     * @param serverContext context object providing settings and objects
     */
<span class="fc" id="L101">    public LayoutServer(@Nonnull ServerContext serverContext) {</span>
<span class="fc" id="L102">        this.serverContext = serverContext;</span>

<span class="fc" id="L104">        this.paxosDataStore = PaxosDataStore.builder()</span>
<span class="fc" id="L105">                .dataStore(serverContext.getDataStore())</span>
<span class="fc" id="L106">                .build();</span>

<span class="fc" id="L108">        executor = Executors.newFixedThreadPool(</span>
<span class="fc" id="L109">                serverContext.getLayoutServerThreadCount(),</span>
                new ServerThreadFactory(&quot;layoutServer-&quot;, new ExceptionHandler())
        );

<span class="fc bfc" id="L113" title="All 2 branches covered.">        if (serverContext.installSingleNodeLayoutIfAbsent()) {</span>
<span class="fc" id="L114">            setLayoutInHistory(getCurrentLayout());</span>
        }
<span class="fc" id="L116">    }</span>

    private boolean isBootstrapped(CorfuMsg msg, ChannelHandlerContext ctx, IServerRouter r) {
<span class="fc bfc" id="L119" title="All 2 branches covered.">        if (getCurrentLayout() == null) {</span>
<span class="fc" id="L120">            log.warn(&quot;Received message but not bootstrapped! Message={}&quot;, msg);</span>
<span class="fc" id="L121">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.LAYOUT_NOBOOTSTRAP));</span>
<span class="fc" id="L122">            return false;</span>
        }
<span class="fc" id="L124">        return true;</span>
    }

    // Helper Methods

    /**
     * Handle a layout request message.
     *
     * @param msg              corfu message containing LAYOUT_REQUEST
     * @param ctx              netty ChannelHandlerContext
     * @param r                server router
     */
    @ServerHandler(type = CorfuMsgType.LAYOUT_REQUEST)
    public synchronized void handleMessageLayoutRequest(CorfuPayloadMsg&lt;Long&gt; msg,
                                                    ChannelHandlerContext ctx, IServerRouter r) {
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (!isBootstrapped(msg, ctx, r)) {</span>
<span class="fc" id="L140">            return;</span>
        }

<span class="fc" id="L143">        final long msgEpoch = msg.getPayload();</span>
<span class="fc" id="L144">        final long serverEpoch = getServerEpoch();</span>

<span class="pc bpc" id="L146" title="1 of 2 branches missed.">        if (msgEpoch &lt;= serverEpoch) {</span>
<span class="fc" id="L147">            r.sendResponse(ctx, msg, new LayoutMsg(getCurrentLayout(), CorfuMsgType</span>
                    .LAYOUT_RESPONSE));
        } else {
            // else the client is somehow ahead of the server.
            //TODO figure out a strategy to deal with this situation
<span class="nc" id="L152">            r.sendResponse(ctx, msg, new CorfuPayloadMsg&lt;&gt;(CorfuMsgType.WRONG_EPOCH, serverEpoch));</span>
<span class="nc" id="L153">            log.warn(&quot;handleMessageLayoutRequest: Message Epoch {} ahead of Server epoch {}&quot;,</span>
<span class="nc" id="L154">                    msgEpoch, serverEpoch);</span>
        }
<span class="fc" id="L156">    }</span>

    /**
     * Sets the new layout if the server has not been bootstrapped with one already.
     *
     * @param msg corfu message containing LAYOUT_BOOTSTRAP
     * @param ctx netty ChannelHandlerContext
     * @param r   server router
     */
    @ServerHandler(type = CorfuMsgType.LAYOUT_BOOTSTRAP)
    public synchronized void handleMessageLayoutBootstrap(
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">            @NonNull CorfuPayloadMsg&lt;LayoutBootstrapRequest&gt; msg,</span>
            ChannelHandlerContext ctx,
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">            @NonNull IServerRouter r) {</span>

<span class="fc bfc" id="L171" title="All 2 branches covered.">        if (getCurrentLayout() == null) {</span>
<span class="fc" id="L172">            log.info(&quot;handleMessageLayoutBootstrap: Bootstrap with new layout={}, {}&quot;,</span>
<span class="fc" id="L173">                    msg.getPayload().getLayout(), msg);</span>
<span class="fc" id="L174">            setCurrentLayout(msg.getPayload().getLayout());</span>
<span class="fc" id="L175">            serverContext.setServerEpoch(getCurrentLayout().getEpoch(), r);</span>
            //send a response that the bootstrap was successful.
<span class="fc" id="L177">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.ACK));</span>
        } else {
            // We are already bootstrapped, bootstrap again is not allowed.
<span class="fc" id="L180">            log.warn(&quot;handleMessageLayoutBootstrap: Got a request to bootstrap a server which is &quot;</span>
                    + &quot;already bootstrapped, rejecting!&quot;);
<span class="fc" id="L182">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.LAYOUT_ALREADY_BOOTSTRAP));</span>
        }
<span class="fc" id="L184">    }</span>

    /**
     * Accepts a prepare message if the rank is higher than any accepted so far.
     *
     * @param msg corfu message containing LAYOUT_PREPARE
     * @param ctx netty ChannelHandlerContext
     * @param r   server router
     */
    // TODO this can work under a separate lock for this step as it does not change the global
    // components
    @ServerHandler(type = CorfuMsgType.LAYOUT_PREPARE)
    public synchronized void handleMessageLayoutPrepare(
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">            @NonNull CorfuPayloadMsg&lt;LayoutPrepareRequest&gt; msg,</span>
            ChannelHandlerContext ctx,
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">            @NonNull IServerRouter r) {</span>

        // Check if the prepare is for the correct epoch
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">        if (!isBootstrapped(msg, ctx, r)) {</span>
<span class="nc" id="L203">            return;</span>
        }

<span class="fc" id="L206">        final long payloadEpoch = msg.getPayload().getEpoch();</span>
<span class="fc" id="L207">        final long serverEpoch = getServerEpoch();</span>

<span class="fc" id="L209">        final Rank prepareRank = new Rank(msg.getPayload().getRank(), msg.getClientID());</span>
<span class="fc" id="L210">        final Rank phase1Rank = getPhase1Rank(payloadEpoch);</span>

<span class="fc bfc" id="L212" title="All 2 branches covered.">        if (payloadEpoch != serverEpoch) {</span>
<span class="fc" id="L213">            r.sendResponse(ctx, msg, new CorfuPayloadMsg&lt;&gt;(CorfuMsgType.WRONG_EPOCH, serverEpoch));</span>
<span class="fc" id="L214">            log.trace(&quot;handleMessageLayoutPrepare: Incoming message with wrong epoch, got {}, &quot;</span>
                            + &quot;expected {}, message was: {}&quot;,
<span class="fc" id="L216">                    msg.getPayload().getEpoch(), serverEpoch, msg);</span>
<span class="fc" id="L217">            return;</span>
        }

<span class="fc" id="L220">        Layout proposedLayout = getProposedLayout(payloadEpoch);</span>

        // This is a prepare. If the rank is less than or equal to the phase 1 rank, reject.
<span class="fc bfc" id="L223" title="All 4 branches covered.">        if (phase1Rank != null &amp;&amp; prepareRank.lessThanEqualTo(phase1Rank)) {</span>
<span class="fc" id="L224">            log.debug(&quot;handleMessageLayoutPrepare: Rejected phase 1 prepare of rank={}, &quot;</span>
                    + &quot;phase1Rank={}&quot;, prepareRank, phase1Rank);
<span class="fc" id="L226">            r.sendResponse(ctx, msg, CorfuMsgType.LAYOUT_PREPARE_REJECT.payloadMsg(new</span>
<span class="fc" id="L227">                    LayoutPrepareResponse(phase1Rank.getRank(), proposedLayout)));</span>
        } else {
            // Return the layout with the highest rank proposed before.
<span class="fc bfc" id="L230" title="All 2 branches covered.">            Rank highestProposedRank = proposedLayout == null ? new Rank(-1L, msg.getClientID())</span>
<span class="fc" id="L231">                    : getPhase2Rank(payloadEpoch);</span>
<span class="fc" id="L232">            setPhase1Rank(prepareRank, payloadEpoch);</span>
<span class="fc" id="L233">            log.debug(&quot;handleMessageLayoutPrepare: New phase 1 rank={}&quot;, prepareRank);</span>
<span class="fc" id="L234">            r.sendResponse(ctx, msg, CorfuMsgType.LAYOUT_PREPARE_ACK.payloadMsg(new</span>
<span class="fc" id="L235">                    LayoutPrepareResponse(highestProposedRank.getRank(), proposedLayout)));</span>
        }
<span class="fc" id="L237">    }</span>

    /**
     * Accepts a proposal for which it had accepted in the prepare phase.
     * A minor optimization is to reject any duplicate propose messages.
     *
     * @param msg corfu message containing LAYOUT_PROPOSE
     * @param ctx netty ChannelHandlerContext
     * @param r   server router
     */
    @ServerHandler(type = CorfuMsgType.LAYOUT_PROPOSE)
    public synchronized void handleMessageLayoutPropose(
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">            @NonNull CorfuPayloadMsg&lt;LayoutProposeRequest&gt; msg,</span>
            ChannelHandlerContext ctx,
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">            @NonNull IServerRouter r) {</span>

<span class="pc bpc" id="L253" title="1 of 2 branches missed.">        if (!isBootstrapped(msg, ctx, r)) {</span>
<span class="nc" id="L254">            return;</span>
        }

<span class="fc" id="L257">        final long payloadEpoch = msg.getPayload().getEpoch();</span>
<span class="fc" id="L258">        final long serverEpoch = getServerEpoch();</span>

<span class="fc" id="L260">        final Rank proposeRank = new Rank(msg.getPayload().getRank(), msg.getClientID());</span>
<span class="fc" id="L261">        final Rank phase1Rank = getPhase1Rank(payloadEpoch);</span>

        // Check if the propose is for the correct epoch
<span class="fc bfc" id="L264" title="All 2 branches covered.">        if (payloadEpoch != serverEpoch) {</span>
<span class="fc" id="L265">            r.sendResponse(ctx, msg, new CorfuPayloadMsg&lt;&gt;(CorfuMsgType.WRONG_EPOCH, serverEpoch));</span>
<span class="fc" id="L266">            log.trace(&quot;handleMessageLayoutPropose: Incoming message with wrong epoch, got {}, &quot;</span>
<span class="fc" id="L267">                            + &quot;expected {}, message was: {}&quot;, payloadEpoch, serverEpoch, msg);</span>
<span class="fc" id="L268">            return;</span>
        }
        // This is a propose. If no prepare, reject.
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">        if (phase1Rank == null) {</span>
<span class="nc" id="L272">            log.debug(&quot;handleMessageLayoutPropose: Rejected phase 2 propose of rank={}, &quot;</span>
                    + &quot;phase1Rank=none&quot;, proposeRank);
<span class="nc" id="L274">            r.sendResponse(ctx, msg, CorfuMsgType.LAYOUT_PROPOSE_REJECT.payloadMsg(new</span>
                    LayoutProposeResponse(-1)));
<span class="nc" id="L276">            return;</span>
        }
        // This is a propose. If the rank in the proposal is less than or equal to the highest yet
        // observed prepare rank, reject.
<span class="fc bfc" id="L280" title="All 2 branches covered.">        if (!proposeRank.equals(phase1Rank)) {</span>
<span class="fc" id="L281">            log.debug(&quot;handleMessageLayoutPropose: Rejected phase 2 propose of rank={}, &quot;</span>
                    + &quot;phase1Rank={}&quot;, proposeRank, phase1Rank);
<span class="fc" id="L283">            r.sendResponse(ctx, msg, CorfuMsgType.LAYOUT_PROPOSE_REJECT.payloadMsg(new</span>
<span class="fc" id="L284">                    LayoutProposeResponse(phase1Rank.getRank())));</span>
<span class="fc" id="L285">            return;</span>
        }

<span class="fc" id="L288">        final Rank phase2Rank = getPhase2Rank(payloadEpoch);</span>
<span class="fc" id="L289">        final Layout proposeLayout = msg.getPayload().getLayout();</span>

        // Make sure that the layout epoch is the same as the LayoutProposeRequest epoch.
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">        if (proposeLayout.getEpoch() != payloadEpoch) {</span>
<span class="nc" id="L293">            log.debug(&quot;Phase II error: layout {} and payload {} epoch should be the same&quot;,</span>
<span class="nc" id="L294">                    proposeLayout.getEpoch(), payloadEpoch);</span>
<span class="nc" id="L295">            r.sendResponse(ctx, msg, CorfuMsgType.LAYOUT_PROPOSE_REJECT.payloadMsg(new</span>
<span class="nc" id="L296">                    LayoutProposeResponse(phase1Rank.getRank())));</span>
<span class="nc" id="L297">            return;</span>
        }

        // In addition, if the rank in the propose message is equal to the current phase 2 rank
        // (already accepted message), reject.
        // This can happen in case of duplicate messages.
<span class="fc bfc" id="L303" title="All 2 branches covered.">        if (proposeRank.equals(phase2Rank)) {</span>
<span class="fc" id="L304">            log.debug(&quot;handleMessageLayoutPropose: Rejected phase 2 propose of rank={}, &quot;</span>
                    + &quot;phase2Rank={}&quot;, proposeRank, phase2Rank);
<span class="fc" id="L306">            r.sendResponse(ctx, msg, CorfuMsgType.LAYOUT_PROPOSE_REJECT.payloadMsg(new</span>
<span class="fc" id="L307">                    LayoutProposeResponse(phase2Rank.getRank())));</span>
<span class="fc" id="L308">            return;</span>
        }

<span class="fc" id="L311">        log.debug(&quot;handleMessageLayoutPropose: New phase 2 rank={}, layout={}&quot;,</span>
                proposeRank, proposeLayout);
<span class="fc" id="L313">        setPhase2Data(new Phase2Data(proposeRank, proposeLayout), payloadEpoch);</span>
<span class="fc" id="L314">        r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.ACK));</span>
<span class="fc" id="L315">    }</span>


    /**
     * Force layout enables the server to bypass consensus
     * and accept a new layout.
     *
     * @param msg              corfu message containing LAYOUT_FORCE
     * @param ctx              netty ChannelHandlerContext
     * @param r                server router
     */
    private synchronized void forceLayout(@Nonnull CorfuPayloadMsg&lt;LayoutCommittedRequest&gt; msg,
                                               @Nonnull ChannelHandlerContext ctx,
                                               @Nonnull IServerRouter r) {
<span class="nc" id="L329">        final long payloadEpoch = msg.getPayload().getEpoch();</span>
<span class="nc" id="L330">        final long serverEpoch = getServerEpoch();</span>

<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (payloadEpoch != serverEpoch) {</span>
            // return can't force old epochs
<span class="nc" id="L334">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.NACK));</span>
<span class="nc" id="L335">            log.warn(&quot;forceLayout: Trying to force a layout with an old epoch. Layout {}, &quot; +</span>
<span class="nc" id="L336">                    &quot;current epoch {}&quot;, payloadEpoch, serverEpoch);</span>
<span class="nc" id="L337">            return;</span>
        }

<span class="nc" id="L340">        final Layout msgLayout = msg.getPayload().getLayout();</span>

<span class="nc" id="L342">        setCurrentLayout(msgLayout);</span>
<span class="nc" id="L343">        serverContext.setServerEpoch(msgLayout.getEpoch(), r);</span>
<span class="nc" id="L344">        log.warn(&quot;forceLayout: Forcing new layout {}&quot;, msgLayout);</span>
<span class="nc" id="L345">        r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.ACK));</span>
<span class="nc" id="L346">    }</span>


    /**
     * Accepts any committed layouts for the current epoch or newer epochs.
     * As part of the accept, the server changes it's current layout and epoch.
     *
     * @param msg corfu message containing LAYOUT_COMMITTED
     * @param ctx netty ChannelHandlerContext
     * @param r   server router
     */
    // TODO If a server does not get SEAL layout commit message cannot reach it
    // TODO as this message is not set to ignore EPOCH.
    // TODO How do we handle holes in history if we let in layout commit message. Maybe we have a
    // hole filling process
    @ServerHandler(type = CorfuMsgType.LAYOUT_COMMITTED)
    public synchronized void handleMessageLayoutCommit(
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">            @NonNull CorfuPayloadMsg&lt;LayoutCommittedRequest&gt; msg,</span>
            ChannelHandlerContext ctx,
<span class="pc bpc" id="L365" title="1 of 2 branches missed.">            @NonNull IServerRouter r) {</span>

<span class="pc bpc" id="L367" title="1 of 2 branches missed.">        if (msg.getPayload().getForce()) {</span>
<span class="nc" id="L368">            forceLayout(msg, ctx, r);</span>
<span class="nc" id="L369">            return;</span>
        }

<span class="fc bfc" id="L372" title="All 2 branches covered.">        if (!isBootstrapped(msg, ctx, r)) {</span>
<span class="fc" id="L373">            return;</span>
        }

<span class="fc" id="L376">        final long payloadEpoch = msg.getPayload().getEpoch();</span>
<span class="fc" id="L377">        final long serverEpoch = getServerEpoch();</span>
<span class="fc" id="L378">        final Layout msgLayout = msg.getPayload().getLayout();</span>

<span class="fc bfc" id="L380" title="All 2 branches covered.">        if (payloadEpoch &lt; serverEpoch) {</span>
<span class="fc" id="L381">            r.sendResponse(ctx, msg, new CorfuPayloadMsg&lt;&gt;(CorfuMsgType.WRONG_EPOCH, serverEpoch));</span>
<span class="fc" id="L382">            return;</span>
        }

<span class="fc" id="L385">        setCurrentLayout(msgLayout);</span>
<span class="fc" id="L386">        serverContext.setServerEpoch(payloadEpoch, r);</span>
<span class="fc" id="L387">        log.info(&quot;New layout committed: {}&quot;, msgLayout);</span>
<span class="fc" id="L388">        r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.ACK));</span>
<span class="fc" id="L389">    }</span>


    public Layout getCurrentLayout() {
<span class="fc" id="L393">        Layout layout = serverContext.getCurrentLayout();</span>
<span class="fc bfc" id="L394" title="All 2 branches covered.">        if (layout != null) {</span>
<span class="fc" id="L395">            return new Layout(layout);</span>
        } else {
<span class="fc" id="L397">            return null;</span>
        }
    }

    /**
     * Sets the current layout in context DataStore.
     *
     * @param layout layout to set
     */
    public void setCurrentLayout(Layout layout) {
<span class="fc" id="L407">        serverContext.setCurrentLayout(layout);</span>
        // set the layout in history as well
<span class="fc" id="L409">        setLayoutInHistory(layout);</span>
<span class="fc" id="L410">    }</span>

    public Rank getPhase1Rank(long epoch) {
<span class="fc" id="L413">        return paxosDataStore</span>
<span class="fc" id="L414">                .getPhase1Rank(epoch)</span>
<span class="fc" id="L415">                .orElse(null);</span>
    }

    public void setPhase1Rank(Rank rank, long epoch) {
<span class="fc" id="L419">        paxosDataStore.setPhase1Rank(rank, epoch);</span>
<span class="fc" id="L420">    }</span>

    public void setPhase2Data(Phase2Data phase2Data, long epoch) {
<span class="fc" id="L423">        paxosDataStore.setPhase2Data(phase2Data, epoch);</span>
<span class="fc" id="L424">    }</span>

    public void setLayoutInHistory(Layout layout) {
<span class="fc" id="L427">        serverContext.setLayoutInHistory(layout);</span>
<span class="fc" id="L428">    }</span>

    private long getServerEpoch() {
<span class="fc" id="L431">        return serverContext.getServerEpoch();</span>
    }

    /**
     * Returns the phase 2 rank.
     *
     * @return the phase 2 rank
     */
    public Rank getPhase2Rank(long epoch) {
<span class="fc" id="L440">        return paxosDataStore</span>
<span class="fc" id="L441">                .getPhase2Data(epoch)</span>
<span class="fc" id="L442">                .map(Phase2Data::getRank)</span>
<span class="fc" id="L443">                .orElse(null);</span>
    }

    /**
     * Returns the proposed layout received in phase 2 data.
     *
     * @return the proposed layout
     */
    public Layout getProposedLayout(long epoch) {
<span class="fc" id="L452">        return paxosDataStore</span>
<span class="fc" id="L453">                .getPhase2Data(epoch)</span>
<span class="fc" id="L454">                .map(Phase2Data::getLayout)</span>
<span class="fc" id="L455">                .orElse(null);</span>
    }

    /**
     * Return accepted data for the given epoch.
     *
     * @param epoch that we are interested in
     * @return {@link Optional} {@link Phase2Data}
     */
    @VisibleForTesting
    Optional&lt;Phase2Data&gt; getPhase2Data(long epoch) {
<span class="fc" id="L466">        return paxosDataStore.getPhase2Data(epoch);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>