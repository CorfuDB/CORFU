<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CorfuServer.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">debian</a> &gt; <a href="../index.html" class="el_bundle">infrastructure</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.infrastructure</a> &gt; <span class="el_source">CorfuServer.java</span></div><h1>CorfuServer.java</h1><pre class="source lang-java linenums">package org.corfudb.infrastructure;

import static org.corfudb.util.NetworkUtils.getAddressFromInterfaceName;

import ch.qos.logback.classic.Level;
import ch.qos.logback.classic.Logger;
import ch.qos.logback.core.joran.spi.JoranException;

import java.io.File;
import java.io.IOException;
import java.util.Map;

import com.codahale.metrics.MetricRegistry;
import lombok.extern.slf4j.Slf4j;

import org.apache.commons.io.FileUtils;
import org.corfudb.common.metrics.MetricsServer;
import org.corfudb.common.metrics.servers.PrometheusMetricsServer;
import org.corfudb.runtime.CorfuRuntime;
import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;
import org.corfudb.util.GitRepositoryState;
import org.docopt.Docopt;
import org.slf4j.LoggerFactory;


/**
 * This is the new Corfu server single-process executable.
 *
 * &lt;p&gt;The command line options are documented in the USAGE variable.
 *
 * &lt;p&gt;Created by mwei on 11/30/15.
 */

<span class="nc" id="L34">@Slf4j</span>
<span class="nc" id="L35">public class CorfuServer {</span>
    /**
     * This string defines the command line arguments,
     * in the docopt DSL (see http://docopt.org) for the executable.
     * It also serves as the documentation for the executable.
     *
     * &lt;p&gt;Unfortunately, Java doesn't support multi-line string literals,
     * so you must concatenate strings and terminate with newlines.
     *
     * &lt;p&gt;Note that the java implementation of docopt has a strange requirement
     * that each option must be preceded with a space.
     */
    private static final String USAGE =
            &quot;Corfu Server, the server for the Corfu Infrastructure.\n&quot;
                    + &quot;\n&quot;
                    + &quot;Usage:\n&quot;
                    + &quot;\tcorfu_server (-l &lt;path&gt;|-m) [-nsN] [-a &lt;address&gt;|-q &lt;interface-name&gt;] &quot;
                    + &quot;[-t &lt;token&gt;] [-c &lt;ratio&gt;] [-d &lt;level&gt;] [-p &lt;seconds&gt;] &quot;
                    + &quot;[--layout-server-threads=&lt;layout_server_threads&gt;] [--base-server-threads=&lt;base_server_threads&gt;] &quot;
                    + &quot;[--log-size-quota-percentage=&lt;max_log_size_percentage&gt;]&quot;
                    + &quot;[--logunit-threads=&lt;logunit_threads&gt;] [--management-server-threads=&lt;management_server_threads&gt;]&quot;
                    + &quot;[-e [-u &lt;keystore&gt; -f &lt;keystore_password_file&gt;] [-r &lt;truststore&gt; -w &lt;truststore_password_file&gt;] &quot;
                    + &quot;[-b] [-g -o &lt;username_file&gt; -j &lt;password_file&gt;] &quot;
                    + &quot;[-k &lt;seqcache&gt;] [-T &lt;threads&gt;] [-B &lt;size&gt;] [-i &lt;channel-implementation&gt;] &quot;
                    + &quot;[-H &lt;seconds&gt;] [-I &lt;cluster-id&gt;] [-x &lt;ciphers&gt;] [-z &lt;tls-protocols&gt;]] &quot;
                    + &quot;[--metrics] [--metrics-port &lt;metrics_port&gt;]&quot;
                    + &quot;[-P &lt;prefix&gt;] [-R &lt;retention&gt;] [--agent] &lt;port&gt;\n&quot;
                    + &quot;\n&quot;
                    + &quot;Options:\n&quot;
                    + &quot; -l &lt;path&gt;, --log-path=&lt;path&gt;                                             &quot;
                    + &quot;              Set the path to the storage file for the log unit.\n&quot;
                    + &quot; -s, --single                                                             &quot;
                    + &quot;              Deploy a single-node configuration.\n&quot;
                    + &quot; -I &lt;cluster-id&gt;, --cluster-id=&lt;cluster-id&gt;&quot;
                    + &quot;              For a single node configuration the cluster id to use in UUID,&quot;
                    + &quot;              base64 format, or auto to randomly generate [default: auto].\n&quot;
                    + &quot; -T &lt;threads&gt;, --Threads=&lt;threads&gt;                                        &quot;
                    + &quot;              Number of corfu server worker threads, or 0 to use 2x the &quot;
                    + &quot;              number of available processors [default: 0].\n&quot;
                    + &quot; -P &lt;prefix&gt; --Prefix=&lt;prefix&gt;&quot;
                    + &quot;              The prefix to use for threads (useful for debugging multiple&quot;
                    + &quot;              servers) [default: ].&quot;
                    + &quot;                                                                          &quot;
                    + &quot;              The server will be bootstrapped with a simple one-unit layout.&quot;
                    + &quot;\n -a &lt;address&gt;, --address=&lt;address&gt;                                      &quot;
                    + &quot;                IP address for the server router to bind to and to &quot;
                    + &quot;advertise to external clients.\n&quot;
                    + &quot; -q &lt;interface-name&gt;, --network-interface=&lt;interface-name&gt;                &quot;
                    + &quot;              The name of the network interface.\n&quot;
                    + &quot; -i &lt;channel-implementation&gt;, --implementation &lt;channel-implementation&gt;   &quot;
                    + &quot;              The type of channel to use (auto, nio, epoll, kqueue)&quot;
                    + &quot;[default: nio].\n&quot;
                    + &quot; -m, --memory                                                             &quot;
                    + &quot;              Run the unit in-memory (non-persistent).\n&quot;
                    + &quot;                                                                          &quot;
                    + &quot;              Data will be lost when the server exits!\n&quot;
                    + &quot; -c &lt;ratio&gt;, --cache-heap-ratio=&lt;ratio&gt;                                   &quot;
                    + &quot;              The ratio of jvm max heap size we will use for the the &quot;
                    + &quot;in-memory cache to serve requests from -\n&quot;
                    + &quot;                                                                          &quot;
                    + &quot;              (e.g. ratio = 0.5 means the cache size will be 0.5 * jvm max &quot;
                    + &quot;heap size\n&quot;
                    + &quot;                                                                          &quot;
                    + &quot;              If there is no log, then this will be the size of the log unit&quot;
                    + &quot;\n                                                                        &quot;
                    + &quot;                evicted entries will be auto-trimmed. [default: 0.5].\n&quot;
                    + &quot; -H &lt;seconds&gt;, --HandshakeTimeout=&lt;seconds&gt;                               &quot;
                    + &quot;              Handshake timeout in seconds [default: 10].\n               &quot;
                    + &quot; -t &lt;token&gt;, --initial-token=&lt;token&gt;                                      &quot;
                    + &quot;              The first token the sequencer will issue, or -1 to recover\n&quot;
                    + &quot;                                                                          &quot;
                    + &quot;              from the log. [default: -1].\n                              &quot;
                    + &quot;                                                                          &quot;
                    + &quot; -k &lt;seqcache&gt;, --sequencer-cache-size=&lt;seqcache&gt;                         &quot;
                    + &quot;               The size of the sequencer's cache. [default: 250000].\n    &quot;
                    + &quot; -B &lt;size&gt; --batch-size=&lt;size&gt;                                            &quot;
                    + &quot;              The read/write batch size used for data transfer operations [default: 100].\n&quot;
                    + &quot; -R &lt;retention&gt;, --metadata-retention=&lt;retention&gt;                         &quot;
                    + &quot;              Maximum number of system reconfigurations (i.e. layouts)    &quot;
                    + &quot;retained for debugging purposes [default: 1000].\n&quot;
                    + &quot; -p &lt;seconds&gt;, --compact=&lt;seconds&gt;                                        &quot;
                    + &quot;              The rate the log unit should compact entries (find the,\n&quot;
                    + &quot;                                                                          &quot;
                    + &quot;              contiguous tail) in seconds [default: 60].\n&quot;
                    + &quot; -d &lt;level&gt;, --log-level=&lt;level&gt;                                          &quot;
                    + &quot;              Set the logging level, valid levels are: \n&quot;
                    + &quot;                                                                          &quot;
                    + &quot;              ALL,ERROR,WARN,INFO,DEBUG,TRACE,OFF [default: INFO].\n&quot;
                    + &quot; -n, --no-verify                                                          &quot;
                    + &quot;              Disable checksum computation and verification.\n&quot;
                    + &quot; -N, --no-sync                                                            &quot;
                    + &quot;              Disable syncing writes to secondary storage.\n&quot;
                    + &quot; -e, --enable-tls                                                         &quot;
                    + &quot;              Enable TLS.\n&quot;
                    + &quot; -u &lt;keystore&gt;, --keystore=&lt;keystore&gt;                                     &quot;
                    + &quot;              Path to the key store.\n&quot;
                    + &quot; -f &lt;keystore_password_file&gt;, &quot;
                    + &quot;--keystore-password-file=&lt;keystore_password_file&gt;         Path to the file &quot;
                    + &quot;containing the key store password.\n&quot;
                    + &quot; -b, --enable-tls-mutual-auth                                             &quot;
                    + &quot;              Enable TLS mutual authentication.\n&quot;
                    + &quot; -r &lt;truststore&gt;, --truststore=&lt;truststore&gt;                               &quot;
                    + &quot;              Path to the trust store.\n&quot;
                    + &quot; -w &lt;truststore_password_file&gt;, &quot;
                    + &quot;--truststore-password-file=&lt;truststore_password_file&gt;   Path to the file &quot;
                    + &quot;containing the trust store password.\n&quot;
                    + &quot; -g, --enable-sasl-plain-text-auth                                        &quot;
                    + &quot;              Enable SASL Plain Text Authentication.\n&quot;
                    + &quot; -o &lt;username_file&gt;, --sasl-plain-text-username-file=&lt;username_file&gt;      &quot;
                    + &quot;              Path to the file containing the username for SASL Plain Text &quot;
                    + &quot;Authentication.\n&quot;
                    + &quot; -j &lt;password_file&gt;, --sasl-plain-text-password-file=&lt;password_file&gt;      &quot;
                    + &quot;              Path to the file containing the password for SASL Plain Text &quot;
                    + &quot;Authentication.\n&quot;
                    + &quot; -x &lt;ciphers&gt;, --tls-ciphers=&lt;ciphers&gt;                                    &quot;
                    + &quot;              Comma separated list of TLS ciphers to use.\n&quot;
                    + &quot;                                                                          &quot;
                    + &quot;              [default: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256].\n&quot;
                    + &quot; -z &lt;tls-protocols&gt;, --tls-protocols=&lt;tls-protocols&gt;                      &quot;
                    + &quot;              Comma separated list of TLS protocols to use.\n&quot;
                    + &quot;                                                                          &quot;
                    + &quot;              [default: TLSv1.1,TLSv1.2].\n&quot;
                    + &quot; --base-server-threads=&lt;base_server_threads&gt;                              &quot;
                    + &quot;              Number of threads dedicated for the base server.\n          &quot;
                    + &quot; --log-size-quota-percentage=&lt;max_log_size_percentage&gt;                    &quot;
                    + &quot;              The max size as percentage of underlying file-store size.\n &quot;
                    + &quot;              If this limit is exceeded &quot;
                    + &quot;              write requests will be rejected [default: 100.0].\n         &quot;
                    + &quot;                                                                          &quot;
                    + &quot; --layout-server-threads=&lt;layout_server_threads&gt;                          &quot;
                    + &quot;              Number of threads dedicated for the layout server.\n        &quot;
                    + &quot;                                                                          &quot;
                    + &quot; --management-server-threads=&lt;management_server_threads&gt;                  &quot;
                    + &quot;              Number of threads dedicated for the management server.\n&quot;
                    + &quot;                                                                          &quot;
                    + &quot; --logunit-threads=&lt;logunit_threads&gt;                  &quot;
                    + &quot;              Number of threads dedicated for the logunit server.\n&quot;
                    + &quot;                                                                          &quot;
                    + &quot; --agent      Run with byteman agent to enable runtime code injection.\n  &quot;
                    + &quot; --metrics                                                                &quot;
                    + &quot;              Enable metrics provider.\n                                  &quot;
                    + &quot; --metrics-port=&lt;metrics_port&gt;                                            &quot;
                    + &quot;              Metrics provider server port [default: 9999].\n             &quot;
                    + &quot; -h, --help                                                               &quot;
                    + &quot;              Show this screen\n&quot;
                    + &quot; --version                                                                &quot;
                    + &quot;              Show version\n&quot;;

    // Active Corfu Server.
    private static volatile CorfuServerNode activeServer;

    // Flag if set to true - causes the Corfu Server to shutdown.
<span class="nc" id="L187">    private static volatile boolean shutdownServer = false;</span>
    // If set to true - triggers a reset of the server by wiping off all the data.
<span class="nc" id="L189">    private static volatile boolean cleanupServer = false;</span>
    // Error code required to detect an ungraceful shutdown.
    private static final int EXIT_ERROR_CODE = 100;

    /**
     * Main program entry point.
     *
     * @param args command line argument strings
     */
    public static void main(String[] args) {

        // Parse the options given, using docopt.
<span class="nc" id="L201">        Map&lt;String, Object&gt; opts = new Docopt(USAGE)</span>
<span class="nc" id="L202">                .withVersion(GitRepositoryState.getRepositoryState().describe)</span>
<span class="nc" id="L203">                .parse(args);</span>
        // Print a nice welcome message.
<span class="nc" id="L205">        printStartupMsg(opts);</span>
<span class="nc" id="L206">        configureLogger(opts);</span>

<span class="nc" id="L208">        log.debug(&quot;Started with arguments: {}&quot;, opts);</span>

        // Bind to all interfaces only if no address or interface specified by the user.
        // Fetch the address if given a network interface.
<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (opts.get(&quot;--network-interface&quot;) != null) {</span>
<span class="nc" id="L213">            opts.put(&quot;--address&quot;, getAddressFromInterfaceName((String) opts.get(&quot;--network-interface&quot;)));</span>
<span class="nc" id="L214">            opts.put(&quot;--bind-to-all-interfaces&quot;, false);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">        } else if (opts.get(&quot;--address&quot;) == null) {</span>
            // Default the address to localhost and set the bind to all interfaces flag to true,
            // if the address and interface is not specified.
<span class="nc" id="L218">            opts.put(&quot;--bind-to-all-interfaces&quot;, true);</span>
<span class="nc" id="L219">            opts.put(&quot;--address&quot;, &quot;localhost&quot;);</span>
        } else {
            // Address is specified by the user.
<span class="nc" id="L222">            opts.put(&quot;--bind-to-all-interfaces&quot;, false);</span>
        }

<span class="nc" id="L225">        createServiceDirectory(opts);</span>

        // Check the specified number of datastore files to retain
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (Integer.parseInt((String) opts.get(&quot;--metadata-retention&quot;)) &lt; 1) {</span>
<span class="nc" id="L229">            throw new IllegalArgumentException(&quot;Max number of metadata files to retain must be greater than 0.&quot;);</span>
        }

        // Register shutdown handler
<span class="nc" id="L233">        Thread shutdownThread = new Thread(CorfuServer::cleanShutdown);</span>
<span class="nc" id="L234">        shutdownThread.setName(&quot;ShutdownThread&quot;);</span>
<span class="nc" id="L235">        Runtime.getRuntime().addShutdownHook(shutdownThread);</span>

        // Manages the lifecycle of the Corfu Server.
<span class="nc bnc" id="L238" title="All 2 branches missed.">        while (!shutdownServer) {</span>
<span class="nc" id="L239">            final ServerContext serverContext = new ServerContext(opts);</span>
            try {
<span class="nc" id="L241">                MetricRegistry metricRegistry = CorfuRuntime.getDefaultMetrics();</span>
<span class="nc" id="L242">                setupMetrics(opts, metricRegistry);</span>
<span class="nc" id="L243">                activeServer = new CorfuServerNode(serverContext, metricRegistry);</span>
<span class="nc" id="L244">                activeServer.startAndListen();</span>
<span class="nc" id="L245">            } catch (Throwable th) {</span>
<span class="nc" id="L246">                log.error(&quot;CorfuServer: Server exiting due to unrecoverable error: &quot;, th);</span>
<span class="nc" id="L247">                System.exit(EXIT_ERROR_CODE);</span>
<span class="nc" id="L248">            }</span>

<span class="nc bnc" id="L250" title="All 2 branches missed.">            if (cleanupServer) {</span>
<span class="nc" id="L251">                clearDataFiles(serverContext);</span>
<span class="nc" id="L252">                cleanupServer = false;</span>
            }

<span class="nc bnc" id="L255" title="All 2 branches missed.">            if (!shutdownServer) {</span>
<span class="nc" id="L256">                log.info(&quot;main: Server restarting.&quot;);</span>
            }
<span class="nc" id="L258">        }</span>

<span class="nc" id="L260">        log.info(&quot;main: Server exiting due to shutdown&quot;);</span>
<span class="nc" id="L261">    }</span>

    /**
     * Setup logback logger
     * - pick the correct logging level before outputting error messages
     * - add serverEndpoint information
     *
     * @param opts command line parameters
     * @throws JoranException logback exception
     */
    private static void configureLogger(Map&lt;String, Object&gt; opts) {
<span class="nc" id="L272">        final Logger root = (Logger) LoggerFactory.getLogger(Logger.ROOT_LOGGER_NAME);</span>
<span class="nc" id="L273">        final Level level = Level.toLevel(((String) opts.get(&quot;--log-level&quot;)).toUpperCase());</span>
<span class="nc" id="L274">        root.setLevel(level);</span>
<span class="nc" id="L275">    }</span>

    /**
     * Create the service directory if it does not exist.
     *
     * @param opts Server options map.
     */
    private static void createServiceDirectory(Map&lt;String, Object&gt; opts) {
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if ((Boolean) opts.get(&quot;--memory&quot;)) {</span>
<span class="nc" id="L284">            return;</span>
        }

<span class="nc" id="L287">        File serviceDir = new File((String) opts.get(&quot;--log-path&quot;));</span>

<span class="nc bnc" id="L289" title="All 2 branches missed.">        if (!serviceDir.isDirectory()) {</span>
<span class="nc" id="L290">            log.error(&quot;Service directory {} does not point to a directory. Aborting.&quot;,</span>
                    serviceDir);
<span class="nc" id="L292">            throw new UnrecoverableCorfuError(&quot;Service directory must be a directory!&quot;);</span>
        }

<span class="nc" id="L295">        String corfuServiceDirPath = serviceDir.getAbsolutePath()</span>
                + File.separator
                + &quot;corfu&quot;;
<span class="nc" id="L298">        File corfuServiceDir = new File(corfuServiceDirPath);</span>
        // Update the new path with the dedicated child service directory.
<span class="nc" id="L300">        opts.put(&quot;--log-path&quot;, corfuServiceDirPath);</span>
<span class="nc bnc" id="L301" title="All 4 branches missed.">        if (!corfuServiceDir.exists() &amp;&amp; corfuServiceDir.mkdirs()) {</span>
<span class="nc" id="L302">            log.info(&quot;Created new service directory at {}.&quot;, corfuServiceDir);</span>
        }
<span class="nc" id="L304">    }</span>

    /**
     * Clear all data files to reset the server.
     *
     * @param serverContext Server context.
     */
    private static void clearDataFiles(ServerContext serverContext) {
<span class="nc" id="L312">        log.warn(&quot;main: cleanup requested, DELETE server data files&quot;);</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">        if (!serverContext.getServerConfig(Boolean.class, &quot;--memory&quot;)) {</span>
<span class="nc" id="L314">            File serviceDir = new File(serverContext.getServerConfig(String.class, &quot;--log-path&quot;));</span>
            try {
<span class="nc" id="L316">                FileUtils.cleanDirectory(serviceDir);</span>
<span class="nc" id="L317">            } catch (IOException ioe) {</span>
<span class="nc" id="L318">                throw new UnrecoverableCorfuError(ioe);</span>
<span class="nc" id="L319">            }</span>
        }
<span class="nc" id="L321">        log.warn(&quot;main: cleanup completed, expect clean startup&quot;);</span>
<span class="nc" id="L322">    }</span>

    /**
     * Cleanly shuts down the server and restarts.
     *
     * @param resetData Resets and clears all data if True.
     */
    static void restartServer(boolean resetData) {

<span class="nc bnc" id="L331" title="All 2 branches missed.">        if (resetData) {</span>
<span class="nc" id="L332">            cleanupServer = true;</span>
        }

<span class="nc" id="L335">        log.info(&quot;RestartServer: Shutting down corfu server&quot;);</span>
<span class="nc" id="L336">        activeServer.close();</span>
<span class="nc" id="L337">        log.info(&quot;RestartServer: Starting corfu server&quot;);</span>
<span class="nc" id="L338">    }</span>

    /**
     * Attempt to cleanly shutdown all the servers.
     */
    private static void cleanShutdown() {
<span class="nc" id="L344">        log.info(&quot;CleanShutdown: Starting Cleanup.&quot;);</span>
<span class="nc" id="L345">        shutdownServer = true;</span>
<span class="nc" id="L346">        activeServer.close();</span>
<span class="nc" id="L347">    }</span>

    /**
     * Print the corfu logo.
     */
    private static void printLogo() {
<span class="nc" id="L353">        println(&quot;▄████████  ▄██████▄     ▄████████    ▄████████ ███    █▄&quot;);</span>
<span class="nc" id="L354">        println(&quot;███    ███ ███    ███   ███    ███   ███    ██████    ███&quot;);</span>
<span class="nc" id="L355">        println(&quot;███    █▀  ███    ███   ███    ███   ███    █▀ ███    ███&quot;);</span>
<span class="nc" id="L356">        println(&quot;███        ███    ███  ▄███▄▄▄▄██▀  ▄███▄▄▄    ███    ███&quot;);</span>
<span class="nc" id="L357">        println(&quot;███        ███    ███ ▀▀███▀▀▀▀▀   ▀▀███▀▀▀    ███    ███&quot;);</span>
<span class="nc" id="L358">        println(&quot;███    █▄  ███    ███ ▀███████████   ███       ███    ███&quot;);</span>
<span class="nc" id="L359">        println(&quot;███    ███ ███    ███   ███    ███   ███       ███    ███&quot;);</span>
<span class="nc" id="L360">        println(&quot;████████▀   ▀██████▀    ███    ███   ███       ████████▀ &quot;);</span>
<span class="nc" id="L361">        println(&quot;                        ███    ███&quot;);</span>
<span class="nc" id="L362">    }</span>

    /**
     * Print an object to the console, followed by a newline.
     * Call this method instead of calling System.out.println().
     *
     * @param line The object to print.
     */
    @SuppressWarnings(&quot;checkstyle:printLine&quot;)
    private static void println(Object line) {
<span class="nc" id="L372">        System.out.println(line);</span>
<span class="nc" id="L373">        log.info(line.toString());</span>
<span class="nc" id="L374">    }</span>

    /**
     * Print the welcome message, logo and the arguments.
     *
     * @param opts Arguments.
     */
    private static void printStartupMsg(Map&lt;String, Object&gt; opts) {
<span class="nc" id="L382">        printLogo();</span>
<span class="nc" id="L383">        println(&quot;Welcome to CORFU SERVER&quot;);</span>
<span class="nc" id="L384">        println(&quot;Version (&quot; + GitRepositoryState.getRepositoryState().commitIdAbbrev + &quot;)&quot;);</span>

<span class="nc" id="L386">        final int port = Integer.parseInt((String) opts.get(&quot;&lt;port&gt;&quot;));</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">        final String dataLocation = (Boolean) opts.get(&quot;--memory&quot;) ? &quot;MEMORY mode&quot; :</span>
<span class="nc" id="L388">                opts.get(&quot;--log-path&quot;).toString();</span>

<span class="nc" id="L390">        println(&quot;Serving on port &quot; + port);</span>
<span class="nc" id="L391">        println(&quot;Data location: &quot; + dataLocation);</span>
<span class="nc" id="L392">    }</span>

    /**
     * Generate metrics server config and start server.
     *
     * @param opts Command line parameters.
     */
    private static void setupMetrics(Map&lt;String, Object&gt; opts, MetricRegistry metricRegistry) {
<span class="nc" id="L400">        PrometheusMetricsServer.Config config = PrometheusMetricsServer.Config.parse(opts);</span>
<span class="nc" id="L401">        MetricsServer server = new PrometheusMetricsServer(config, metricRegistry);</span>
<span class="nc" id="L402">        server.start();</span>
<span class="nc" id="L403">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>