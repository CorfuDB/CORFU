<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>RecoveryHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">debian</a> &gt; <a href="../index.html" class="el_bundle">infrastructure</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.infrastructure</a> &gt; <span class="el_source">RecoveryHandler.java</span></div><h1>RecoveryHandler.java</h1><pre class="source lang-java linenums">package org.corfudb.infrastructure;

import lombok.NonNull;
import lombok.extern.slf4j.Slf4j;
import org.corfudb.runtime.CorfuRuntime;
import org.corfudb.runtime.view.Layout;

<span class="nc" id="L8">@Slf4j</span>
class RecoveryHandler {

<span class="nc" id="L11">    private RecoveryHandler() {</span>
        // Hide implicit public constructor.
<span class="nc" id="L13">    }</span>

    /**
     * This is called when the management server detects an existing layout in the local datastore
     * on startup. This requires a recovery from the same layout and attempt to rejoin the cluster.
     * Recovery is carried out as follows:
     * - Attempt to run reconfiguration on the cluster from the recovered layout found in the
     * local data store by incrementing the epoch.
     * The reconfiguration succeeds if the attempt to reach consensus by re-proposing this
     * recovery layout with its epoch incremented succeeds.
     * - If reconfiguration succeeds, the node is added to the layout and recovery was successful.
     * - If reconfiguration fails, the cluster has moved ahead.
     * * - This node now cannot force its inclusion into the cluster (it has a stale layout).
     * * - This node if marked unresponsive will be detected and unmarked by its peers in cluster.
     * - If multiple nodes are trying to recover, they will retry until they have recovered with
     * the latest layout previously accepted by the majority.
     * eg. Consider 3 nodes [Node(Epoch)]:
     * A(1), B(2), C(2). All 3 nodes crash and attempt to recover at the same time.
     * Node A should not be able to recover as it will detect a higher epoch in the rest of the
     * cluster. Hence either node B or C will succeed in recovering the cluster to epoch 3 with
     * their persisted layout.
     *
     * @return True if recovery was successful. False otherwise.
     */
<span class="nc bnc" id="L37" title="All 2 branches missed.">    static boolean runRecoveryReconfiguration(@NonNull Layout layout, CorfuRuntime corfuRuntime) {</span>
<span class="nc" id="L38">        Layout localRecoveryLayout = new Layout(layout);</span>
<span class="nc" id="L39">        boolean recoveryReconfigurationResult = corfuRuntime.getLayoutManagementView().attemptClusterRecovery(layout);</span>
<span class="nc" id="L40">        log.info(&quot;Recovery reconfiguration attempt result: {}&quot;, recoveryReconfigurationResult);</span>

<span class="nc" id="L42">        corfuRuntime.invalidateLayout();</span>
<span class="nc" id="L43">        Layout clusterLayout = corfuRuntime.getLayoutView().getLayout();</span>

<span class="nc" id="L45">        log.info(&quot;Recovery layout epoch:{}, Cluster epoch: {}&quot;,</span>
<span class="nc" id="L46">                localRecoveryLayout.getEpoch(), clusterLayout.getEpoch());</span>

        // The cluster has moved ahead. This node should not force any layout.
        // Let the healing workflow kick in and include it in the layout.
<span class="nc bnc" id="L50" title="All 4 branches missed.">        return clusterLayout.getEpoch() &gt; localRecoveryLayout.getEpoch()</span>
                || recoveryReconfigurationResult;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>