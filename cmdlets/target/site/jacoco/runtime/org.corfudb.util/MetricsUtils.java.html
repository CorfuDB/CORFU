<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MetricsUtils.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">cmdlets</a> &gt; <a href="../index.html" class="el_bundle">runtime</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.util</a> &gt; <span class="el_source">MetricsUtils.java</span></div><h1>MetricsUtils.java</h1><pre class="source lang-java linenums">package org.corfudb.util;

import com.codahale.metrics.Counter;
import com.codahale.metrics.CsvReporter;
import com.codahale.metrics.Gauge;
import com.codahale.metrics.JmxReporter;
import com.codahale.metrics.MetricFilter;
import com.codahale.metrics.MetricRegistry;
import com.codahale.metrics.MetricSet;
import com.codahale.metrics.RatioGauge;
import com.codahale.metrics.Slf4jReporter;
import com.codahale.metrics.Timer;
import com.codahale.metrics.jvm.BufferPoolMetricSet;
import com.codahale.metrics.jvm.ClassLoadingGaugeSet;
import com.codahale.metrics.jvm.FileDescriptorRatioGauge;
import com.codahale.metrics.jvm.GarbageCollectorMetricSet;
import com.codahale.metrics.jvm.MemoryUsageGaugeSet;
import com.codahale.metrics.jvm.ThreadStatesGaugeSet;
import com.github.benmanes.caffeine.cache.Cache;

import io.netty.buffer.PooledByteBufAllocator;

import java.io.File;
import java.lang.management.ManagementFactory;
import java.lang.ref.WeakReference;
import java.util.concurrent.TimeUnit;

import org.ehcache.sizeof.SizeOf;
import org.slf4j.LoggerFactory;

import lombok.Getter;
import lombok.NonNull;
import lombok.extern.slf4j.Slf4j;

<span class="nc" id="L35">@Slf4j</span>
public class MetricsUtils {

<span class="nc" id="L38">    private MetricsUtils() {</span>
        // Preventing instantiation of this utility class
<span class="nc" id="L40">    }</span>

<span class="nc" id="L42">    private static final Gauge&lt;Long&gt; metricsJVMUptime =</span>
<span class="nc" id="L43">            () -&gt; ManagementFactory.getRuntimeMXBean().getUptime();</span>
<span class="nc" id="L44">    private static final RatioGauge metricsJVMFdGauge = new FileDescriptorRatioGauge();</span>
<span class="nc" id="L45">    private static final MetricSet metricsBuffPooled =</span>
<span class="nc" id="L46">            new BufferPoolMetricSet(ManagementFactory.getPlatformMBeanServer());</span>
<span class="nc" id="L47">    private static final MetricSet metricsClassLoadingGauge = new ClassLoadingGaugeSet();</span>
<span class="nc" id="L48">    private static final MetricSet metricsJVMGC = new GarbageCollectorMetricSet();</span>
<span class="nc" id="L49">    private static final MetricSet metricsJVMMem = new MemoryUsageGaugeSet();</span>
<span class="nc" id="L50">    private static final MetricSet metricsJVMThread = new ThreadStatesGaugeSet();</span>

    // Domain prefix for reporting Corfu metrics
    private static final String CORFU_METRICS = &quot;corfu.metrics&quot;;

    // JVM flags used for configuration of collection and reporting of metrics
    private static final String PROPERTY_CSV_FOLDER = &quot;corfu.metrics.csv.folder&quot;;
    private static final String PROPERTY_CSV_INTERVAL = &quot;corfu.metrics.csv.interval&quot;;
    private static final String PROPERTY_JMX_REPORTING = &quot;corfu.metrics.jmxreporting&quot;;
    private static final String PROPERTY_JVM_METRICS_COLLECTION = &quot;corfu.metrics.jvm&quot;;
    private static final String PROPERTY_LOG_INTERVAL = &quot;corfu.metrics.log.interval&quot;;
    private static final String PROPERTY_METRICS_COLLECTION = &quot;corfu.metrics.collection&quot;;

    private static final String ADDRESS_SPACE_METRIC_PREFIX = &quot;corfu.runtime.as-view&quot;;
<span class="nc" id="L64">    private static final MetricFilter ADDRESS_SPACE_FILTER =</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            (name, metric) -&gt; !name.contains(ADDRESS_SPACE_METRIC_PREFIX);</span>

    private static long metricsCsvInterval;
    private static long metricsLogInterval;
    private static String metricsCsvFolder;
<span class="nc" id="L70">    @Getter</span>
<span class="nc" id="L71">    private static boolean metricsCollectionEnabled = false;</span>
<span class="nc" id="L72">    private static boolean metricsCsvReportingEnabled = false;</span>
<span class="nc" id="L73">    private static boolean metricsJmxReportingEnabled = false;</span>
<span class="nc" id="L74">    private static boolean metricsJvmCollectionEnabled = false;</span>
<span class="nc" id="L75">    private static boolean metricsSlf4jReportingEnabled = false;</span>
    private static final String mpTrigger = &quot;filter-trigger&quot;; // internal use only

<span class="nc" id="L78">    public static final SizeOf sizeOf = SizeOf.newInstance();</span>

    /**
     * Load metrics properties.
     *
     * &lt;p&gt;The following properties can be set using jvm flags:
     * &lt;ul&gt;
     * &lt;li&gt; metricsCollectionEnabled: Boolean taken from jvm corfu.metrics.collection
     * property to enable the metrics collection.
     * &lt;li&gt; metricsJmxReportingEnabled: Boolean taken from jvm corfu.metrics.jmxreporting
     * property to enable jmx reporting of metrics.
     * &lt;li&gt; metricsJvmCollectionEnabled: Boolean taken from jvm corfu.metrics.jvm
     * property for enabling reporting on jmv metrics such as garbage collection, threads,
     * and memory consumption.
     * &lt;li&gt; metricsLogAnalysisEnabled: Boolean taken from jvm corfu.metrics.log.analysis
     * property for enabling reporting on logger statistics.
     * &lt;li&gt; metricsLogInterval: Integer taken from jvm corfu.metrics.log.interval
     * property for enabling and setting the intervals of reporting to log output (in
     * seconds). A positive value indicates the reporting is enabled at provided
     * intervals.
     * &lt;li&gt; metricsCsvInterval: Integer taken from jvm corfu.metrics.csv.interval
     * property for enabling and setting the intervals of reporting to csv (in seconds).
     * A positive value indicates the reporting is enabled at provided intervals.
     * &lt;li&gt; metricsCsvFolder: String taken from jvm corfu.metrics.csv.folder
     * property for destination path of csv reporting.
     * &lt;/ul&gt;
     *
     * &lt;p&gt;This method will be called to set the value of above-mentioned properties
     * for collection and reporting. For example using the following jvm flags will
     * enable collection of corfu, jvm, and log statistics and their reporting through
     * logs, csv, and jmx.
     *
     * {@code -Dcorfu.metrics.collection=True
     * -Dcorfu.metrics.csv.interval=30
     * -Dcorfu.metrics.csv.folder=/tmp/csv5
     * -Dcorfu.metrics.jmxreporting=True
     * -Dcorfu.metrics.log.analysis=True
     * -Dcorfu.metrics.jvm=True
     * -Dcorfu.metrics.log.interval=60}
     */
    private static void loadVmProperties() {
<span class="nc" id="L119">        metricsCollectionEnabled = Boolean.valueOf(System.getProperty(PROPERTY_METRICS_COLLECTION));</span>

<span class="nc" id="L121">        metricsJmxReportingEnabled = Boolean.valueOf(System.getProperty(PROPERTY_JMX_REPORTING));</span>
<span class="nc" id="L122">        metricsJvmCollectionEnabled = Boolean.valueOf(System.getProperty(PROPERTY_JVM_METRICS_COLLECTION));</span>

<span class="nc" id="L124">        metricsLogInterval = Long.valueOf(System.getProperty(PROPERTY_LOG_INTERVAL, &quot;0&quot;));</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">        metricsSlf4jReportingEnabled = metricsLogInterval &gt; 0;</span>

<span class="nc" id="L127">        metricsCsvInterval = Long.valueOf(System.getProperty(PROPERTY_CSV_INTERVAL, &quot;0&quot;));</span>
<span class="nc" id="L128">        metricsCsvFolder = String.valueOf(System.getProperty(PROPERTY_CSV_FOLDER));</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        metricsCsvReportingEnabled = metricsCsvInterval &gt; 0;</span>
<span class="nc" id="L130">    }</span>

    /**
     * Check whether the metrics reporting has been already set up using metricsReportingSetup.
     *
     * @param metrics Metric Registry
     * @return a boolean representing whether metrics reporting has been already set up.
     * earlier
     */
<span class="nc bnc" id="L139" title="All 2 branches missed.">    public static boolean isMetricsReportingSetUp(@NonNull MetricRegistry metrics) {</span>
<span class="nc" id="L140">        return metrics.getNames().contains(mpTrigger);</span>
    }

    /**
     * Start metrics reporting via the Dropwizard 'CsvReporter', 'JmxReporter',
     * and 'Slf4jReporter'. Reporting can be turned on and off via the system
     * properties described in loadVmProperties()'s docs.
     * The report interval and report directory cannot be altered at runtime.
     *
     * @param metrics Metrics registry
     */
<span class="nc bnc" id="L151" title="All 2 branches missed.">    public static void metricsReportingSetup(@NonNull MetricRegistry metrics) {</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (isMetricsReportingSetUp(metrics)) {</span>
<span class="nc" id="L153">            return;</span>
        }
<span class="nc" id="L155">        metrics.counter(mpTrigger);</span>

<span class="nc" id="L157">        loadVmProperties();</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (metricsCollectionEnabled) {</span>
<span class="nc" id="L160">            setupCsvReporting(metrics);</span>
<span class="nc" id="L161">            setupJvmMetrics(metrics);</span>
<span class="nc" id="L162">            setupJmxReporting(metrics);</span>
<span class="nc" id="L163">            setupSlf4jReporting(metrics);</span>
<span class="nc" id="L164">            log.info(&quot;Corfu metrics collection and all reporting types are enabled&quot;);</span>
        } else {
<span class="nc" id="L166">            log.info(&quot;Corfu metrics collection and all reporting types are disabled&quot;);</span>
        }
<span class="nc" id="L168">    }</span>

    // If enabled, setup jmx reporting
    private static void setupJmxReporting(MetricRegistry metrics) {
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (!metricsJmxReportingEnabled) return;</span>

        // This filters noisy addressSpace metrics to have a clean JMX reporting
<span class="nc" id="L175">        JmxReporter jmxReporter = JmxReporter.forRegistry(metrics)</span>
<span class="nc" id="L176">                .convertDurationsTo(TimeUnit.MICROSECONDS)</span>
<span class="nc" id="L177">                .convertRatesTo(TimeUnit.SECONDS)</span>
<span class="nc" id="L178">                .inDomain(CORFU_METRICS)</span>
<span class="nc" id="L179">                .filter(ADDRESS_SPACE_FILTER)</span>
<span class="nc" id="L180">                .build();</span>
<span class="nc" id="L181">        jmxReporter.start();</span>
<span class="nc" id="L182">    }</span>

    // If enabled, setup slf4j reporting
    private static void setupSlf4jReporting(MetricRegistry metrics) {
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (!metricsSlf4jReportingEnabled) return;</span>

<span class="nc bnc" id="L188" title="All 2 branches missed.">        MetricFilter mpTriggerFilter = (name, metric) -&gt; !name.equals(mpTrigger);</span>

<span class="nc" id="L190">        Slf4jReporter slf4jReporter = Slf4jReporter.forRegistry(metrics)</span>
<span class="nc" id="L191">                .convertDurationsTo(TimeUnit.MICROSECONDS)</span>
<span class="nc" id="L192">                .convertRatesTo(TimeUnit.SECONDS)</span>
<span class="nc" id="L193">                .outputTo(LoggerFactory.getLogger(&quot;org.corfudb.metricsdata&quot;))</span>
<span class="nc" id="L194">                .filter(mpTriggerFilter)</span>
<span class="nc" id="L195">                .build();</span>
<span class="nc" id="L196">        slf4jReporter.start(metricsLogInterval, TimeUnit.SECONDS);</span>
<span class="nc" id="L197">    }</span>

    // If enabled, setup csv reporting
    private static void setupCsvReporting(MetricRegistry metrics) {
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (!metricsCsvReportingEnabled) return;</span>

<span class="nc" id="L203">        final File directory = new File(metricsCsvFolder);</span>

<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (!directory.isDirectory() ||</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">            !directory.exists() ||</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            !directory.canWrite()) {</span>
<span class="nc" id="L208">            log.warn(&quot;Provided CSV directory : {} doesn't exist, isn't a directory, or &quot; +</span>
                    &quot;not accessible for writes. Disabling CSV Reporting.&quot;, directory);
<span class="nc" id="L210">            metricsCsvReportingEnabled = false;</span>
<span class="nc" id="L211">            return;</span>
        }
<span class="nc" id="L213">        CsvReporter csvReporter = CsvReporter.forRegistry(metrics)</span>
<span class="nc" id="L214">                .convertDurationsTo(TimeUnit.MICROSECONDS)</span>
<span class="nc" id="L215">                .convertRatesTo(TimeUnit.SECONDS)</span>
<span class="nc" id="L216">                .filter(ADDRESS_SPACE_FILTER)</span>
<span class="nc" id="L217">                .build(directory);</span>
<span class="nc" id="L218">        csvReporter.start(metricsCsvInterval, TimeUnit.SECONDS);</span>
<span class="nc" id="L219">    }</span>

    // If enabled, setup reporting of JVM metrics including garbage collection,
    // memory, thread statistics, buffer, uptime, class loading, netty's direct and heap
    // allocations.
<span class="nc bnc" id="L224" title="All 2 branches missed.">    private static void setupJvmMetrics(@NonNull MetricRegistry metrics) {</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (!metricsJvmCollectionEnabled) return;</span>

        try {
<span class="nc" id="L228">            metrics.register(&quot;jvm.buffers&quot;, metricsBuffPooled);</span>
<span class="nc" id="L229">            metrics.register(&quot;jvm.class-loading&quot;, metricsClassLoadingGauge);</span>
<span class="nc" id="L230">            metrics.register(&quot;jvm.file-descriptors-used&quot;, metricsJVMFdGauge);</span>
<span class="nc" id="L231">            metrics.register(&quot;jvm.gc&quot;, metricsJVMGC);</span>
<span class="nc" id="L232">            metrics.register(&quot;jvm.memory&quot;, metricsJVMMem);</span>
<span class="nc" id="L233">            metrics.register(&quot;jvm.thread&quot;, metricsJVMThread);</span>
<span class="nc" id="L234">            metrics.register(&quot;jvm.uptime&quot;, metricsJVMUptime);</span>
<span class="nc" id="L235">            metrics.register(&quot;corfu.netty.mem.pooled-byte-buf.direct&quot;, getNettyPooledDirectMemGauge());</span>
<span class="nc" id="L236">            metrics.register(&quot;corfu.netty.mem.pooled-byte-buf.heap&quot;, getNettyPooledHeapMemGauge());</span>
<span class="nc" id="L237">        } catch (IllegalArgumentException e) {</span>
            // Re-registering metrics during test runs, not a problem
<span class="nc" id="L239">        }</span>
<span class="nc" id="L240">    }</span>

<span class="nc bnc" id="L242" title="All 2 branches missed.">    public static Timer.Context getConditionalContext(@NonNull Timer t) {</span>
<span class="nc" id="L243">        return getConditionalContext(metricsCollectionEnabled, t);</span>
    }

<span class="nc bnc" id="L246" title="All 2 branches missed.">    public static Timer.Context getConditionalContext(boolean enabled, @NonNull Timer t) {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">        return enabled ? t.time() : null;</span>
    }

    public static void stopConditionalContext(Timer.Context context) {
<span class="nc bnc" id="L251" title="All 2 branches missed.">        if (context != null) {</span>
<span class="nc" id="L252">            context.stop();</span>
        }
<span class="nc" id="L254">    }</span>

<span class="nc bnc" id="L256" title="All 2 branches missed.">    public static void incConditionalCounter(boolean enabled, @NonNull Counter counter, long amount) {</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (enabled) {</span>
<span class="nc" id="L258">            counter.inc(amount);</span>
        }
<span class="nc" id="L260">    }</span>

    /**
     * return a gauge on direct memory used by netty's PooledByteBufAllocator
     */
    private static Gauge&lt;Long&gt; getNettyPooledDirectMemGauge() {
<span class="nc" id="L266">        return new Gauge&lt;Long&gt;() {</span>
            @Override
            public Long getValue() {
<span class="nc" id="L269">                return PooledByteBufAllocator.DEFAULT.metric().usedDirectMemory();</span>
            }
        };
    }

    /**
     * return a gauge on heap memory used by netty's PooledByteBufAllocator
     */
    private static Gauge&lt;Long&gt; getNettyPooledHeapMemGauge() {
<span class="nc" id="L278">        return new Gauge&lt;Long&gt;() {</span>
            @Override
            public Long getValue() {
<span class="nc" id="L281">                return PooledByteBufAllocator.DEFAULT.metric().usedHeapMemory();</span>
            }
        };
    }

    /**
     * This method creates object size gauge and registers it to the metrics registry. The
     * method guarantees that no strong reference to the provided object will be retained.
     * Hence it does not prevent garbage collection if the client does not hold a strong
     * reference to the object being measured.
     *
     * @param metrics the metrics registry to which the size gauge will be registered.
     * @param object the object which its size will be measured with a corresponding
     *               gauge*
     *
     * @return a gauge that provides an estimate of deep size for the provided object
     *         as long as there exist a strong reference to that object.
     */
<span class="nc bnc" id="L299" title="All 2 branches missed.">    public static Gauge&lt;Long&gt; addMemoryMeasurerFor(@NonNull MetricRegistry metrics,</span>
                                                   Object object) {
<span class="nc bnc" id="L301" title="All 2 branches missed.">        String simpleClassName = object == null ?</span>
                &quot;Object&quot; :
<span class="nc" id="L303">                object.getClass().getSimpleName();</span>

<span class="nc" id="L305">        return  metrics.register(String.format(&quot;deep-sizeof.%s@%04x&quot;,</span>
                                               simpleClassName,
<span class="nc" id="L307">                                               System.identityHashCode(object)),</span>
<span class="nc" id="L308">                                 getSizeGauge(object));</span>
    }

    /**
     * This method creates a gauge that returned the deep size estimation of an object
     * while there is a reference to it in the code. Otherwise it will return 0 as the
     * object can be claimed by Garbage collection. Note that this gauge guarantees
     * that it will not hold any strong reference to the object that it measures.
     *
     * @param object an object to which its size will be estimated using the return
     *               gauge
     * @return a gauge that provides an estimate of deep size for the provided object
     *         as long as there exist a strong reference to that object.
     */
    private static Gauge&lt;Long&gt; getSizeGauge(Object object) {
<span class="nc" id="L323">        WeakReference&lt;Object&gt; toBeMeasuredObject = new WeakReference&lt;&gt;(object);</span>

<span class="nc" id="L325">        return new Gauge&lt;Long&gt;() {</span>
            @Override
            public Long getValue() {
<span class="nc" id="L328">                final Object objectOfInterest = toBeMeasuredObject.get();</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">                return (objectOfInterest != null) ?</span>
<span class="nc" id="L330">                        sizeOf.deepSizeOf(objectOfInterest) :</span>
                        0L;
            }
        };
    }

    /**
     * This method adds different properties of provided instance of {@link Cache} to the
     * indicated metrics registry. The added properties of cache are:
     *
     * cache.object-counts: estimated size of cache.
     * cache.evictions : number of cache evictions
     * cache.hit-rate : hit rate of cache.
     * cache.hits :
     * cache.misses :
     *
     *
     * @param metrics
     * @param cache
     */
<span class="nc bnc" id="L350" title="All 2 branches missed.">    public static void addCacheMeasurerFor(@NonNull MetricRegistry metrics, Cache cache) {</span>
        try {
<span class="nc" id="L352">            metrics.register(&quot;cache.object-counts.&quot; + cache.toString(),</span>
                             (Gauge&lt;Long&gt;) cache::estimatedSize);
<span class="nc" id="L354">            metrics.register(&quot;cache.evictions.&quot; + cache.toString(),</span>
<span class="nc" id="L355">                             (Gauge&lt;Long&gt;) cache.stats()::evictionCount);</span>
<span class="nc" id="L356">            metrics.register(&quot;cache.hit-rate.&quot; + cache.toString(),</span>
<span class="nc" id="L357">                             (Gauge&lt;Double&gt;) cache.stats()::hitRate);</span>
<span class="nc" id="L358">            metrics.register(&quot;cache.hits.&quot; + cache.toString(),</span>
<span class="nc" id="L359">                             (Gauge&lt;Long&gt;) cache.stats()::hitCount);</span>
<span class="nc" id="L360">            metrics.register(&quot;cache.misses.&quot; + cache.toString(),</span>
<span class="nc" id="L361">                             (Gauge&lt;Long&gt;) cache.stats()::missCount);</span>
<span class="nc" id="L362">        } catch (IllegalArgumentException e) {</span>
            // Re-registering metrics during test runs, not a problem
<span class="nc" id="L364">        }</span>
<span class="nc" id="L365">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>